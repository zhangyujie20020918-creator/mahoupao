<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Downloader</title>
    <style>
      :root {
        --primary-color: #646cff;
        --primary-hover: #535bf2;
        --bg-color: #1a1a1a;
        --card-bg: #242424;
        --text-color: rgba(255, 255, 255, 0.87);
        --text-muted: rgba(255, 255, 255, 0.6);
        --border-color: rgba(255, 255, 255, 0.1);
        --success-color: #10b981;
        --error-color: #ef4444;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
          Ubuntu, Cantarell, 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
      }

      #app {
        max-width: 800px;
        margin: 0 auto;
        padding: 2rem;
      }

      .card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
      }

      .title {
        font-size: 2rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 0.5rem;
        background: linear-gradient(135deg, var(--primary-color), #a855f7);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .subtitle {
        text-align: center;
        color: var(--text-muted);
        margin-bottom: 2rem;
      }

      .form-group {
        margin-bottom: 1.5rem;
      }

      .form-label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-muted);
      }

      .form-select,
      .form-input {
        width: 100%;
        padding: 0.75rem 1rem;
        font-size: 1rem;
        background: var(--bg-color);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        color: var(--text-color);
        transition: border-color 0.2s, box-shadow 0.2s;
      }

      .form-select:focus,
      .form-input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(100, 108, 255, 0.2);
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        gap: 0.5rem;
      }

      .btn-primary {
        width: 100%;
        background: var(--primary-color);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        background: var(--primary-hover);
        transform: translateY(-1px);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .result-card {
        margin-top: 1.5rem;
      }

      .result-success {
        border-left: 4px solid var(--success-color);
      }

      .result-error {
        border-left: 4px solid var(--error-color);
      }

      .result-title {
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .result-info {
        display: grid;
        gap: 0.75rem;
      }

      .result-row {
        display: flex;
        gap: 1rem;
      }

      .result-label {
        color: var(--text-muted);
        min-width: 80px;
      }

      .result-value {
        flex: 1;
        word-break: break-all;
      }

      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid var(--border-color);
        border-top-color: var(--primary-color);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        display: inline-block;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .quality-options {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
      }

      .quality-option {
        padding: 0.5rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        background: transparent;
        color: var(--text-color);
        cursor: pointer;
        transition: all 0.2s;
      }

      .quality-option:hover {
        border-color: var(--primary-color);
      }

      .quality-option.active {
        background: var(--primary-color);
        border-color: var(--primary-color);
      }

      /* 平台检测标签 */
      .platform-badge {
        display: inline-block;
        margin-top: 0.5rem;
        padding: 0.25rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        border-radius: 20px;
        background: var(--primary-color);
        color: white;
      }

      .platform-youtube { background: #ff0000; }
      .platform-tiktok { background: #000000; border: 1px solid #333; }
      .platform-douyin { background: #fe2c55; }
      .platform-bilibili { background: #fb7299; }
      .platform-rednote { background: #ff2442; }

      /* 下载报告样式 */
      .report-section {
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
      }

      .report-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .report-header {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--text-muted);
        margin-bottom: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .report-stats {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
      }

      .stat-item {
        text-align: center;
        min-width: 80px;
      }

      .stat-value {
        display: block;
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-color);
        line-height: 1.2;
      }

      .stat-label {
        display: block;
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
      }

      .stat-success .stat-value {
        color: var(--success-color);
      }

      .stat-skipped .stat-value {
        color: #f59e0b;
      }

      .stat-failed .stat-value {
        color: var(--error-color);
      }

      .failed-list {
        background: rgba(239, 68, 68, 0.1);
        border-radius: 8px;
        padding: 0.75rem;
        max-height: 200px;
        overflow-y: auto;
      }

      .failed-item {
        display: flex;
        gap: 0.5rem;
        padding: 0.5rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        font-size: 0.875rem;
      }

      .failed-item:last-child {
        border-bottom: none;
      }

      .failed-index {
        color: var(--text-muted);
        min-width: 24px;
      }

      .failed-title {
        flex: 1;
        color: var(--text-color);
      }

      .failed-error {
        color: var(--error-color);
        font-size: 0.75rem;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <header>
          <h1 class="title">Video Downloader</h1>
          <p class="subtitle">支持 YouTube / TikTok / Bilibili / 小红书</p>
        </header>

        <div class="card">
          <form @submit.prevent="handleSubmit">
            <!-- URL输入 -->
            <div class="form-group">
              <label class="form-label">视频链接</label>
              <input
                v-model="videoUrl"
                type="text"
                class="form-input"
                :placeholder="status === 'loading' ? '下载中...' : '粘贴视频或用户主页URL...'"
                :disabled="status === 'loading'"
                @input="detectPlatform"
              />
              <!-- 自动检测到的平台 -->
              <div v-if="detectedPlatform" class="platform-badge" :class="'platform-' + detectedPlatform.value">
                {{ detectedPlatform.name }}
              </div>
            </div>

            <!-- 画质选择 -->
            <div class="form-group">
              <label class="form-label">画质</label>
              <div class="quality-options">
                <button
                  v-for="q in qualityOptions"
                  :key="q.value"
                  type="button"
                  class="quality-option"
                  :class="{ active: quality === q.value }"
                  @click="quality = q.value"
                >
                  {{ q.label }}
                </button>
              </div>
            </div>

            <!-- 提交按钮 -->
            <button type="submit" class="btn btn-primary" :disabled="status === 'loading'">
              <span v-if="status === 'loading'" class="spinner"></span>
              {{ status === 'loading' ? '下载中...' : '开始下载' }}
            </button>
          </form>
        </div>

        <!-- 结果展示 - 用户主页批量下载报告 -->
        <div v-if="result && result.success && result.summary" class="card result-card result-success">
          <h3 class="result-title">
            <span>&#10003;</span>
            下载完成
          </h3>

          <!-- 用户信息 -->
          <div class="report-section">
            <div class="report-header">用户信息</div>
            <div class="report-stats">
              <div class="stat-item">
                <span class="stat-value">{{ result.summary.username || '未知' }}</span>
                <span class="stat-label">用户名</span>
              </div>
              <div class="stat-item">
                <span class="stat-value">{{ result.summary.video_count || 0 }}</span>
                <span class="stat-label">视频总数</span>
              </div>
              <div class="stat-item" v-if="result.summary.non_video_count > 0">
                <span class="stat-value">{{ result.summary.non_video_count }}</span>
                <span class="stat-label">非视频作品</span>
              </div>
            </div>
          </div>

          <!-- 下载统计 -->
          <div class="report-section">
            <div class="report-header">下载统计</div>
            <div class="report-stats">
              <div class="stat-item stat-success">
                <span class="stat-value">{{ result.summary.succeeded || 0 }}</span>
                <span class="stat-label">新下载</span>
              </div>
              <div class="stat-item stat-skipped">
                <span class="stat-value">{{ result.summary.skipped || 0 }}</span>
                <span class="stat-label">已存在跳过</span>
              </div>
              <div class="stat-item" :class="{ 'stat-failed': result.summary.failed > 0 }">
                <span class="stat-value">{{ result.summary.failed || 0 }}</span>
                <span class="stat-label">失败</span>
              </div>
            </div>
          </div>

          <!-- 详细信息 -->
          <div class="report-section">
            <div class="report-header">详细信息</div>
            <div class="result-info">
              <div class="result-row">
                <span class="result-label">耗时</span>
                <span class="result-value">{{ result.summary.elapsed_time ? result.summary.elapsed_time.toFixed(1) + ' 秒' : '-' }}</span>
              </div>
              <div class="result-row">
                <span class="result-label">保存目录</span>
                <span class="result-value">{{ result.summary.folder_path || '-' }}</span>
              </div>
            </div>
          </div>

          <!-- 失败列表 -->
          <div v-if="result.summary.failed_videos && result.summary.failed_videos.length > 0" class="report-section">
            <div class="report-header" style="color: var(--error-color);">失败的视频</div>
            <div class="failed-list">
              <div v-for="(item, index) in result.summary.failed_videos" :key="index" class="failed-item">
                <span class="failed-index">{{ index + 1 }}.</span>
                <span class="failed-title">{{ item.title || '未知标题' }}</span>
                <span class="failed-error">{{ item.error || '下载失败' }}</span>
              </div>
            </div>
          </div>
        </div>

        <!-- 结果展示 - 单个视频下载 -->
        <div v-if="result && result.success && !result.summary && result.video_info" class="card result-card result-success">
          <h3 class="result-title">
            <span>&#10003;</span>
            下载成功
          </h3>

          <div class="result-info">
            <div class="result-row">
              <span class="result-label">标题</span>
              <span class="result-value">{{ result.video_info.title }}</span>
            </div>
            <div v-if="result.video_info.author" class="result-row">
              <span class="result-label">作者</span>
              <span class="result-value">{{ result.video_info.author }}</span>
            </div>
            <div class="result-row">
              <span class="result-label">时长</span>
              <span class="result-value">{{ formatDuration(result.video_info.duration) }}</span>
            </div>
            <div v-if="result.file_size_human" class="result-row">
              <span class="result-label">文件大小</span>
              <span class="result-value">{{ result.file_size_human }}</span>
            </div>
            <div v-if="result.elapsed_time" class="result-row">
              <span class="result-label">耗时</span>
              <span class="result-value">{{ result.elapsed_time.toFixed(1) }}秒</span>
            </div>
            <div v-if="result.file_path" class="result-row">
              <span class="result-label">保存位置</span>
              <span class="result-value">{{ result.file_path }}</span>
            </div>
          </div>
        </div>

        <!-- 结果展示 - 下载失败 -->
        <div v-if="result && !result.success" class="card result-card result-error">
          <h3 class="result-title">
            <span>&#10007;</span>
            下载失败
          </h3>
          <div class="result-info">
            <p>{{ result.message }}</p>
          </div>
        </div>

        <!-- 错误提示 -->
        <div v-if="errorMessage && !result" class="card result-card result-error">
          <h3 class="result-title">&#10007; 错误</h3>
          <p>{{ errorMessage }}</p>
        </div>
      </div>
    </div>

    <!-- CDN 加载 Vue 3 和 axios -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>

    <script>
      // 自动检测 API 地址：从后端打开用相对路径，双击 HTML 文件用绝对路径
      var API_BASE = window.location.protocol === 'file:'
        ? 'http://localhost:8000/api'
        : '/api';

      var app = Vue.createApp({
        data: function () {
          return {
            platforms: [
              { name: 'YouTube', value: 'youtube', domains: ['youtube.com', 'youtu.be'] },
              { name: 'TikTok', value: 'tiktok', domains: ['tiktok.com', 'vm.tiktok.com', 'vt.tiktok.com'] },
              { name: '抖音', value: 'douyin', domains: ['douyin.com', 'v.douyin.com', 'iesdouyin.com'] },
              { name: 'Bilibili', value: 'bilibili', domains: ['bilibili.com', 'b23.tv'] },
              { name: '小红书', value: 'rednote', domains: ['xiaohongshu.com', 'xhslink.com'] },
            ],
            detectedPlatform: null,
            videoUrl: '',
            quality: 'best',
            status: 'idle',
            result: null,
            errorMessage: '',
            qualityOptions: [
              { value: 'best', label: '最佳画质' },
              { value: '1080p', label: '1080P' },
              { value: '720p', label: '720P' },
              { value: '480p', label: '480P' },
            ],
          };
        },
        mounted: function () {
          // 检查后端是否可用
          var vm = this;
          axios.get(API_BASE + '/platforms', { timeout: 10000 })
            .catch(function (e) {
              console.error('后端连接失败:', e);
              vm.errorMessage = '无法连接后端服务，请确认已启动 python run_server.py';
            });
        },
        methods: {
          detectPlatform: function () {
            var url = this.videoUrl.trim().toLowerCase();
            this.detectedPlatform = null;
            this.errorMessage = '';

            if (!url) return;

            for (var i = 0; i < this.platforms.length; i++) {
              var platform = this.platforms[i];
              for (var j = 0; j < platform.domains.length; j++) {
                if (url.indexOf(platform.domains[j]) !== -1) {
                  this.detectedPlatform = platform;
                  return;
                }
              }
            }
          },
          formatDuration: function (seconds) {
            if (!seconds) return '-';
            var h = Math.floor(seconds / 3600);
            var m = Math.floor((seconds % 3600) / 60);
            var s = seconds % 60;
            if (h > 0) {
              return h + ':' + String(m).padStart(2, '0') + ':' + String(s).padStart(2, '0');
            }
            return m + ':' + String(s).padStart(2, '0');
          },
          handleSubmit: function () {
            if (!this.videoUrl.trim()) {
              this.errorMessage = '请输入视频URL';
              return;
            }

            if (!this.detectedPlatform) {
              this.errorMessage = '无法识别该链接的平台，请检查URL是否正确';
              return;
            }

            var vm = this;
            vm.status = 'loading';
            vm.result = null;
            vm.errorMessage = '';

            axios.post(API_BASE + '/download', {
              url: vm.videoUrl.trim(),
              platform: vm.detectedPlatform.value,
              quality: vm.quality,
              audio_only: false,
            }, { timeout: 7200000 })  // 2小时超时
              .then(function (resp) {
                vm.result = resp.data;
                vm.status = resp.data.success ? 'success' : 'error';
                if (!resp.data.success) {
                  vm.errorMessage = resp.data.message;
                }
              })
              .catch(function (e) {
                vm.status = 'error';
                vm.errorMessage = (e.response && e.response.data && e.response.data.detail) || e.message || '下载失败';
              });
          },
        },
      });

      app.mount('#app');
    </script>
  </body>
</html>
