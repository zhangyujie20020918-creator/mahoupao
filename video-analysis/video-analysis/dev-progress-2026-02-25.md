# å¼€å‘è¿›åº¦ - 2026-02-25

## Video-Analysis-Soul è®¾è®¡æ–‡æ¡£

### 1. é¡¹ç›®æ¦‚è¿°

åŸºäº video-analysis-maker èƒå–çš„äººæ ¼ï¼ˆsystem_promptï¼‰å’Œå‘é‡æ•°æ®åº“ï¼ˆChromaDBï¼‰ï¼Œæ„å»ºæ”¯æŒå¤šç”¨æˆ·ã€é•¿æœŸè®°å¿†çš„æ™ºèƒ½å¯¹è¯ç³»ç»Ÿã€‚

**æ ¸å¿ƒç‰¹æ€§**ï¼š
- å¤š Persona æ”¯æŒï¼šåŠ¨æ€åŠ è½½ä»»æ„å·²è®­ç»ƒçš„äººæ ¼ï¼ˆç½‘çº¢ã€æ˜æ˜Ÿã€ä¸“å®¶ã€è™šæ‹Ÿè§’è‰²ç­‰ï¼‰
- å¤šç”¨æˆ·éš”ç¦»ï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„å¯¹è¯å†å²å’Œè®°å¿†
- é•¿æœŸè®°å¿†ï¼šé€šè¿‡ Preview æœºåˆ¶å®ç°è·¨å¤©è®°å¿†
- æ™ºèƒ½æ£€ç´¢ï¼šLangGraph é©±åŠ¨çš„ä¸Šä¸‹æ–‡å†³ç­–
- åŠ¨æ€ç¼“å­˜ï¼šåŸºäºæ´»è·ƒåº¦çš„ä¼šè¯ç¼“å­˜ç®¡ç†
- é¢†åŸŸæ— å…³ï¼šé€šç”¨çš„æƒ…ç»ªæ£€æµ‹å’Œä¿¡æ¯æå–

---

### 2. ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         soul.html (å‰ç«¯)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  [é€‰æ‹©]  [ç”¨æˆ·é€‰æ‹©]  [æ¨¡å‹é€‰æ‹©]  [+ æ–°ç”¨æˆ·]                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                        èŠå¤©ç•Œé¢                                  â”‚â”‚
â”‚  â”‚  - æµå¼å“åº”                                                      â”‚â”‚
â”‚  â”‚  - å¼•ç”¨æ¥æºæ˜¾ç¤ºï¼ˆè§†é¢‘ç‰‡æ®µï¼‰                                        â”‚â”‚
â”‚  â”‚  - å†å²è®°å½•åŠ è½½                                                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   video-analysis-soul (ç«¯å£ 8004)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    LangGraph å·¥ä½œæµ                            â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚  â”‚
â”‚  â”‚   â”‚  START  â”‚â”€â”€â”€â–¶â”‚ æ„å›¾åˆ†æèŠ‚ç‚¹  â”‚â”€â”€â”€â–¶â”‚ ä¸Šä¸‹æ–‡å†³ç­–èŠ‚ç‚¹   â”‚      â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  â”‚
â”‚  â”‚                                               â”‚               â”‚  â”‚
â”‚  â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”       â”‚  â”‚
â”‚  â”‚                    â–¼                          â–¼       â–¼       â”‚  â”‚
â”‚  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚            â”‚ Preview æ£€ç´¢  â”‚          â”‚ çŸ¥è¯†æ£€ç´¢â”‚ â”‚æ— æ£€ç´¢â”‚   â”‚  â”‚
â”‚  â”‚            â”‚ (å†å²è®°å¿†)    â”‚          â”‚ (ChromaDB) â”‚ â”‚     â”‚   â”‚  â”‚
â”‚  â”‚            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”¬â”€â”€â”˜   â”‚  â”‚
â”‚  â”‚                   â”‚                        â”‚           â”‚      â”‚  â”‚
â”‚  â”‚                   â–¼                        â–¼           â”‚      â”‚  â”‚
â”‚  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚           â”‚      â”‚  â”‚
â”‚  â”‚            â”‚ è¯¦ç»†å†å²åŠ è½½  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚      â”‚  â”‚
â”‚  â”‚            â”‚ (æŒ‰éœ€)       â”‚                            â”‚      â”‚  â”‚
â”‚  â”‚            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚      â”‚  â”‚
â”‚  â”‚                   â”‚                                    â”‚      â”‚  â”‚
â”‚  â”‚                   â–¼                                    â–¼      â”‚  â”‚
â”‚  â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚            â”‚              ç”Ÿæˆå›å¤èŠ‚ç‚¹                    â”‚    â”‚  â”‚
â”‚  â”‚            â”‚  - ç»„è£… system_prompt + ä¸Šä¸‹æ–‡              â”‚    â”‚  â”‚
â”‚  â”‚            â”‚  - è°ƒç”¨ LLM (Gemini)                       â”‚    â”‚  â”‚
â”‚  â”‚            â”‚  - æµå¼è¾“å‡º                                 â”‚    â”‚  â”‚
â”‚  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                              â”‚                                â”‚  â”‚
â”‚  â”‚                              â–¼                                â”‚  â”‚
â”‚  â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚  â”‚
â”‚  â”‚                       â”‚  ä¿å­˜æ¶ˆæ¯   â”‚                          â”‚  â”‚
â”‚  â”‚                       â”‚  END       â”‚                          â”‚  â”‚
â”‚  â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   ç”¨æˆ·ç®¡ç†å™¨     â”‚  â”‚   è®°å¿†ç®¡ç†å™¨     â”‚  â”‚   Persona ç®¡ç†å™¨    â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                     â”‚  â”‚
â”‚  â”‚ â€¢ ç”¨æˆ· CRUD     â”‚  â”‚ â€¢ æ¯æ—¥å¯¹è¯å­˜å‚¨   â”‚  â”‚ â€¢ åŠ è½½ system_promptâ”‚  â”‚
â”‚  â”‚ â€¢ ä¼šè¯ç®¡ç†      â”‚  â”‚ â€¢ Preview æ€»ç»“   â”‚  â”‚ â€¢ åŠ è½½ ChromaDB     â”‚  â”‚
â”‚  â”‚                 â”‚  â”‚ â€¢ å†å²æ£€ç´¢      â”‚  â”‚ â€¢ å‘é‡æ£€ç´¢          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                    Session Cache Manager                      â”‚  â”‚
â”‚  â”‚  â€¢ åŠ¨æ€ä¼šè¯ç¼“å­˜ç®¡ç† (åŸºäºæ´»è·ƒåº¦)                                â”‚  â”‚
â”‚  â”‚  â€¢ å¯é…ç½® idle_timeout (é»˜è®¤ 600s)                             â”‚  â”‚
â”‚  â”‚  â€¢ å†…å­˜é™åˆ¶å’Œ LRU æ·˜æ±°                                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. Persona ç³»ç»Ÿè®¾è®¡

#### 3.1 Persona ç±»å‹

```python
class PersonaType(Enum):
    INFLUENCER = "influencer"   # ç½‘çº¢/
    CELEBRITY = "celebrity"     # æ˜æ˜Ÿ
    EXPERT = "expert"          # ä¸“å®¶
    CHARACTER = "character"    # è™šæ‹Ÿè§’è‰²
    HISTORICAL = "historical"  # å†å²äººç‰©
    CUSTOM = "custom"          # è‡ªå®šä¹‰
```

#### 3.2 ä» video-analysis-maker åˆå§‹åŒ–

**Maker è¾“å‡ºç»“æ„**ï¼š
```
video-analysis-maker/output/{persona_name}/
â”œâ”€â”€ persona.json          # äººè®¾å…ƒæ•°æ®
â”œâ”€â”€ system_prompt.txt     # ç³»ç»Ÿæç¤ºè¯
â”œâ”€â”€ chroma_db/           # å‘é‡æ•°æ®åº“
â””â”€â”€ optimized_texts/     # å¤„ç†åçš„æ–‡æœ¬
```

**persona.json å­—æ®µæ˜ å°„**ï¼š
| Maker å­—æ®µ | Soul å­—æ®µ | è¯´æ˜ |
|-----------|----------|------|
| soul_name | persona_name | äººæ ¼åç§° |
| speaking_style | speaking_style | è¯´è¯é£æ ¼ |
| common_phrases | common_phrases | å¸¸ç”¨è¯­å¥ |
| topic_expertise | topic_expertise | ä¸“ä¸šé¢†åŸŸ |
| personality_traits | personality_traits | äººæ ¼ç‰¹å¾ |
| tone | tone | è¯­æ°” |
| target_audience | target_audience | ç›®æ ‡å—ä¼— |
| content_patterns | content_patterns | å†…å®¹æ¨¡å¼ |
| system_prompt | system_prompt | ç³»ç»Ÿæç¤ºè¯ |

#### 3.3 PersonaManager æ ¸å¿ƒé€»è¾‘

```python
class PersonaManager:
    """ä» video-analysis-maker è¾“å‡ºåŠ è½½ Persona"""

    def __init__(self):
        self.maker_output_dir = Path(settings.maker_output_path)
        self._persona_cache: Dict[str, PersonaMetadata] = {}
        self._chroma_clients: Dict[str, chromadb.PersistentClient] = {}

    def load_persona(self, persona_name: str) -> PersonaMetadata:
        """åŠ è½½ Persona å…ƒæ•°æ®"""
        # 1. è¯»å– persona.json
        # 2. è¯»å– system_prompt.txt (ä¼˜å…ˆ)
        # 3. æ„å»º PersonaMetadata
        # 4. ç¼“å­˜å¹¶è¿”å›

    def get_knowledge_collection(self, persona_name: str) -> chromadb.Collection:
        """è·å– ChromaDB çŸ¥è¯†åº“è¿æ¥"""
        # ç›´æ¥è¿æ¥ maker ç”Ÿæˆçš„ chroma_db ç›®å½•

    def search_knowledge(self, persona_name: str, query: str, n_results: int = 5) -> list:
        """æœç´¢ Persona çŸ¥è¯†åº“"""

    def list_available_personas(self) -> list:
        """æ‰«æ maker è¾“å‡ºç›®å½•ï¼Œåˆ—å‡ºæ‰€æœ‰å¯ç”¨ Persona"""
```

#### 3.4 ChromaDB Collection åç§°è§„åˆ™

ä¸ maker ä¿æŒä¸€è‡´çš„å‘½åè§„åˆ™ï¼š
```python
def _get_collection_name(persona_name: str) -> str:
    """ç”Ÿæˆ ChromaDB collection åç§°"""
    name_hash = hashlib.md5(persona_name.encode('utf-8')).hexdigest()[:8]
    sanitized = re.sub(r'[^a-zA-Z0-9._-]', '', persona_name)

    if not sanitized:
        return f"soul_{name_hash}"

    if not sanitized[0].isalnum():
        sanitized = f"b{sanitized}"
    if not sanitized[-1].isalnum():
        sanitized = f"{sanitized}0"

    return f"{sanitized}_{name_hash}"
```

---

### 4. æ•°æ®å­˜å‚¨è®¾è®¡

#### 4.1 ç›®å½•ç»“æ„

```
soul_data/
â”œâ”€â”€ users/
â”‚   â”œâ”€â”€ {user_id}/
â”‚   â”‚   â”œâ”€â”€ profile.json              # ç”¨æˆ·åŸºæœ¬ä¿¡æ¯
â”‚   â”‚   â”œâ”€â”€ preview.json              # è®°å¿†æ€»è§ˆï¼ˆè·¨å¤©ç´¯ç§¯ï¼‰
â”‚   â”‚   â””â”€â”€ conversations/
â”‚   â”‚       â””â”€â”€ {soul_name}/
â”‚   â”‚           â”œâ”€â”€ 2026-02-25.json   # å½“å¤©å¯¹è¯
â”‚   â”‚           â”œâ”€â”€ 2026-02-24.json   # å†å²å¯¹è¯
â”‚   â”‚           â””â”€â”€ ...
â”‚   â””â”€â”€ index.json                    # ç”¨æˆ·ç´¢å¼•
â”‚
â””â”€â”€ (æ•°æ®å¤ç”¨ maker çš„ output/ ç›®å½•)
```

#### 4.2 æ•°æ®æ¨¡å‹

**profile.json** - ç”¨æˆ·æ¡£æ¡ˆ
```json
{
  "id": "uuid-xxx",
  "name": "å°æ˜",
  "created_at": "2026-02-25T10:00:00",
  "last_active": "2026-02-25T15:30:00"
}
```

**preview.json** - è®°å¿†æ€»è§ˆï¼ˆæ ¸å¿ƒè®¾è®¡ï¼‰
```json
{
  "user_id": "uuid-xxx",
  "last_updated": "2026-02-25T23:59:00",
  "summary_version": 3,
  "memories": [
    {
      "date": "2026-02-25",
      "soul": "å‹‡å“¥è¯´è´¢ç»",
      "summary": {
        "topics_discussed": ["AIåº”ç”¨æ¿å—", "å•†ä¸šèˆªå¤©"],
        "people_mentioned": [
          {"name": "å¼ ä¸‰", "relation": "ç”¨æˆ·çš„æœ‹å‹", "context": "ä¸€èµ·ç‚’è‚¡"}
        ],
        "places": ["åŒ—äº¬", "ä¸Šæµ·è¯åˆ¸äº¤æ˜“æ‰€"],
        "events": [
          {"what": "ç”¨æˆ·ä¹°å…¥äº†AIæ¿å—è‚¡ç¥¨", "when": "ä¸Šå‘¨", "result": "ç›ˆåˆ©"}
        ],
        "emotions": ["ç„¦è™‘ï¼ˆæ‹…å¿ƒè‚¡ç¥¨ä¸‹è·Œï¼‰", "å…´å¥‹ï¼ˆå¬åˆ°åˆ©å¥½æ¶ˆæ¯ï¼‰"],
        "objects": [
          {"name": "çº¢è‰²ç¬”è®°æœ¬", "context": "è®°å½•äº¤æ˜“", "owner": "ç”¨æˆ·"}
        ],
        "user_preferences": ["å–œæ¬¢çŸ­çº¿æ“ä½œ", "å…³æ³¨AIæ–¹å‘"],
        "key_facts": ["æŒæœ‰xxè‚¡ç¥¨", "æœ¬é‡‘çº¦10ä¸‡"]
      }
    },
    {
      "date": "2026-02-24",
      "soul": "å‹‡å“¥è¯´è´¢ç»",
      "summary": { ... }
    }
  ]
}
```

**2026-02-25.json** - æ¯æ—¥å¯¹è¯è®°å½•
```json
{
  "date": "2026-02-25",
  "user_id": "uuid-xxx",
  "soul": "å‹‡å“¥è¯´è´¢ç»",
  "messages": [
    {
      "id": "msg-001",
      "role": "user",
      "content": "ä»Šå¤©AIåº”ç”¨æ€ä¹ˆçœ‹ï¼Ÿ",
      "timestamp": "2026-02-25T10:00:00"
    },
    {
      "id": "msg-002",
      "role": "assistant",
      "content": "å…„å¼Ÿä»¬ï¼AIåº”ç”¨è¿™ä¸ªæ–¹å‘...",
      "timestamp": "2026-02-25T10:00:05",
      "sources": [
        {"video": "xxx", "segment": 3, "relevance": 0.85}
      ]
    }
  ],
  "message_count": 20
}
```

---

### 5. LangGraph å·¥ä½œæµè®¾è®¡

#### 5.1 çŠ¶æ€å®šä¹‰

```python
from typing import TypedDict, List, Optional, Literal
from langgraph.graph import StateGraph

class SoulState(TypedDict):
    # è¾“å…¥
    user_id: str
    soul_name: str
    user_message: str
    model: str

    # åˆ†æç»“æœ
    intent: Literal["greeting", "question", "recall", "chat", "farewell"]
    needs_soul_knowledge: bool      # æ˜¯å¦éœ€è¦çŸ¥è¯†åº“
    needs_memory_recall: bool          # æ˜¯å¦éœ€è¦å›å¿†å†å²
    memory_keywords: List[str]         # éœ€è¦æ£€ç´¢çš„è®°å¿†å…³é”®è¯

    # æ£€ç´¢ç»“æœ
    soul_context: List[str]         # çŸ¥è¯†æ£€ç´¢ç»“æœ
    memory_context: Optional[str]      # å†å²è®°å¿†æ£€ç´¢ç»“æœ
    detailed_history: Optional[str]    # åŠ è½½çš„è¯¦ç»†å†å²

    # å½“å‰ä¸Šä¸‹æ–‡
    today_messages: List[dict]         # ä»Šæ—¥å¯¹è¯å†å²
    preview_summary: dict              # Preview æ€»è§ˆ
    system_prompt: str                 #  system prompt

    # è¾“å‡º
    response: str                      # AI å›å¤
    sources: List[dict]                # å¼•ç”¨æ¥æº
```

#### 5.2 èŠ‚ç‚¹è®¾è®¡

```python
# èŠ‚ç‚¹ 1: æ„å›¾åˆ†æ
def analyze_intent(state: SoulState) -> SoulState:
    """
    åˆ†æç”¨æˆ·æ„å›¾ï¼Œåˆ¤æ–­éœ€è¦ä»€ä¹ˆç±»å‹çš„ä¸Šä¸‹æ–‡

    ä½¿ç”¨è½»é‡æ¨¡å‹ (gemini-2.0-flash-lite) å¿«é€Ÿåˆ†æï¼š
    - greeting: æ‰“æ‹›å‘¼ â†’ ä¸éœ€è¦æ£€ç´¢
    - question: ä¸“ä¸šé—®é¢˜ â†’ éœ€è¦çŸ¥è¯†åº“
    - recall: æåŠè¿‡å» â†’ éœ€è¦è®°å¿†æ£€ç´¢
    - chat: æ—¥å¸¸é—²èŠ â†’ å¯èƒ½éœ€è¦è®°å¿†
    - farewell: å‘Šåˆ« â†’ ä¸éœ€è¦æ£€ç´¢

    è¿”å›: intent, needs_soul_knowledge, needs_memory_recall, memory_keywords
    """
    pass

# èŠ‚ç‚¹ 2: ä¸Šä¸‹æ–‡å†³ç­–ï¼ˆæ¡ä»¶è·¯ç”±ï¼‰
def route_context(state: SoulState) -> str:
    """
    æ ¹æ®æ„å›¾å†³å®šèµ°å“ªä¸ªæ£€ç´¢åˆ†æ”¯

    è¿”å›: "soul_search" | "memory_search" | "both" | "direct"
    """
    if state["needs_soul_knowledge"] and state["needs_memory_recall"]:
        return "both"
    elif state["needs_soul_knowledge"]:
        return "soul_search"
    elif state["needs_memory_recall"]:
        return "memory_search"
    else:
        return "direct"

# èŠ‚ç‚¹ 3a: çŸ¥è¯†æ£€ç´¢
def search_soul_knowledge(state: SoulState) -> SoulState:
    """
    ä» ChromaDB æ£€ç´¢ç›¸å…³è§†é¢‘å†…å®¹

    - æ£€ç´¢ top 5 ç›¸å…³ç‰‡æ®µ
    - å¸¦ä¸Šä¸‹æ–‡çª—å£ (å‰åå„ 2 æ®µ)
    """
    pass

# èŠ‚ç‚¹ 3b: è®°å¿†æ£€ç´¢
def search_memory(state: SoulState) -> SoulState:
    """
    ä» Preview ä¸­æ£€ç´¢ç›¸å…³è®°å¿†

    1. ç”¨ memory_keywords åœ¨ preview.json ä¸­æœç´¢
    2. æ‰¾åˆ°ç›¸å…³çš„ date å’Œ summary
    3. å¦‚æœéœ€è¦æ›´å¤šç»†èŠ‚ï¼Œæ ‡è®° needs_detailed_history
    """
    pass

# èŠ‚ç‚¹ 4: è¯¦ç»†å†å²åŠ è½½ï¼ˆå¯é€‰ï¼‰
def load_detailed_history(state: SoulState) -> SoulState:
    """
    æŒ‰éœ€åŠ è½½ç‰¹å®šæ—¥æœŸçš„è¯¦ç»†å¯¹è¯

    åªåœ¨ memory_context ä¸å¤Ÿè¯¦ç»†æ—¶è§¦å‘
    """
    pass

# èŠ‚ç‚¹ 5: ç”Ÿæˆå›å¤
def generate_response(state: SoulState) -> SoulState:
    """
    ç»„è£…æœ€ç»ˆ promptï¼Œè°ƒç”¨ LLM ç”Ÿæˆå›å¤

    Prompt ç»“æ„ï¼š
    [System Prompt - äººæ ¼]

    [Preview Summary - ç”¨æˆ·è®°å¿†æ€»è§ˆ]
    å…³äºè¿™ä½ç”¨æˆ·ï¼Œä½ è®°å¾—ï¼š
    - ä»–å«{name}
    - ä¸Šæ¬¡èŠè¿‡{topics}
    - ä»–æåˆ°è¿‡{people}

    [Today's Context - ä»Šæ—¥å¯¹è¯]
    ä»Šå¤©çš„å¯¹è¯ï¼š
    ç”¨æˆ·: xxx
    ä½ : xxx

    [Retrieved Context - æ£€ç´¢åˆ°çš„ç›¸å…³å†…å®¹]
    ç›¸å…³è§†é¢‘å†…å®¹ï¼š
    {soul_context}

    ç›¸å…³å†å²è®°å¿†ï¼š
    {memory_context}

    [Current Message]
    ç”¨æˆ·: {user_message}
    """
    pass

# èŠ‚ç‚¹ 6: ä¿å­˜æ¶ˆæ¯
def save_message(state: SoulState) -> SoulState:
    """
    ä¿å­˜ç”¨æˆ·æ¶ˆæ¯å’Œ AI å›å¤åˆ°ä»Šæ—¥ JSON
    """
    pass
```

#### 5.3 Graph æ„å»º

```python
from langgraph.graph import StateGraph, END

# åˆ›å»º Graph
workflow = StateGraph(SoulState)

# æ·»åŠ èŠ‚ç‚¹
workflow.add_node("analyze_intent", analyze_intent)
workflow.add_node("search_soul", search_soul_knowledge)
workflow.add_node("search_memory", search_memory)
workflow.add_node("load_history", load_detailed_history)
workflow.add_node("generate", generate_response)
workflow.add_node("save", save_message)

# è®¾ç½®å…¥å£
workflow.set_entry_point("analyze_intent")

# æ¡ä»¶è·¯ç”±
workflow.add_conditional_edges(
    "analyze_intent",
    route_context,
    {
        "soul_search": "search_soul",
        "memory_search": "search_memory",
        "both": "search_soul",  # å…ˆæœï¼Œå†æœè®°å¿†
        "direct": "generate"
    }
)

# æœç´¢åçš„è·¯ç”±
workflow.add_conditional_edges(
    "search_soul",
    lambda s: "search_memory" if s["needs_memory_recall"] else "generate",
    {
        "search_memory": "search_memory",
        "generate": "generate"
    }
)

# è®°å¿†æœç´¢åçš„è·¯ç”±
workflow.add_conditional_edges(
    "search_memory",
    lambda s: "load_history" if s.get("needs_detailed_history") else "generate",
    {
        "load_history": "load_history",
        "generate": "generate"
    }
)

# è¯¦ç»†å†å² â†’ ç”Ÿæˆ
workflow.add_edge("load_history", "generate")

# ç”Ÿæˆ â†’ ä¿å­˜ â†’ ç»“æŸ
workflow.add_edge("generate", "save")
workflow.add_edge("save", END)

# ç¼–è¯‘
app = workflow.compile()
```

---

### 6. Preview æ€»ç»“æœºåˆ¶

#### 6.1 è§¦å‘æ—¶æœº

- **å®æ—¶å¢é‡**: æ¯ 10 æ¡æ¶ˆæ¯åè§¦å‘ä¸€æ¬¡è½»é‡æ€»ç»“
- **æ¯æ—¥æ±‡æ€»**: æ¯å¤©é¦–æ¬¡å¯¹è¯æ—¶ï¼Œæ€»ç»“å‰ä¸€å¤©å†…å®¹
- **æ‰‹åŠ¨è§¦å‘**: API æ”¯æŒå¼ºåˆ¶åˆ·æ–°

#### 6.2 æ€»ç»“ Prompt

```
ä½ æ˜¯ä¸€ä¸ªè®°å¿†åŠ©æ‰‹ï¼Œè´Ÿè´£æ€»ç»“ç”¨æˆ·å’Œçš„å¯¹è¯ã€‚

è¯·ä»ä»¥ä¸‹å¯¹è¯ä¸­æå–å…³é”®ä¿¡æ¯ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
{
  "topics_discussed": ["è®¨è®ºçš„ä¸»é¢˜"],
  "people_mentioned": [
    {"name": "äººå", "relation": "ä¸ç”¨æˆ·çš„å…³ç³»", "context": "æåŠåœºæ™¯"}
  ],
  "places": ["åœ°å"],
  "events": [
    {"what": "äº‹ä»¶æè¿°", "when": "æ—¶é—´", "result": "ç»“æœ"}
  ],
  "emotions": ["ç”¨æˆ·è¡¨ç°å‡ºçš„æƒ…ç»ª"],
  "objects": [
    {"name": "ç‰©å“å", "context": "ä½¿ç”¨åœºæ™¯", "owner": "æ‰€å±äºº"}
  ],
  "user_preferences": ["ç”¨æˆ·åå¥½"],
  "key_facts": ["é‡è¦äº‹å®"]
}

æ³¨æ„ï¼š
- ä¿ç•™ç»†èŠ‚ä½†ä¸è¦è¿‡äºå†—é•¿
- äººåã€åœ°åã€ç‰©å“åè¦å‡†ç¡®
- æƒ…ç»ªè¦ç»“åˆä¸Šä¸‹æ–‡æè¿°
- å¦‚æœæ²¡æœ‰æŸç±»ä¿¡æ¯ï¼Œè¿”å›ç©ºæ•°ç»„

ä»Šå¤©çš„å¯¹è¯ï¼š
{conversation}
```

---

### 7. åŠ¨æ€ç¼“å­˜ç®¡ç†

#### 7.1 SessionCacheManager

```python
class SessionCacheManager:
    """åŠ¨æ€ä¼šè¯ç¼“å­˜ç®¡ç†å™¨"""

    def __init__(self, config: CacheConfig):
        self.config = config
        self._sessions: Dict[str, SessionData] = {}
        self._lock = asyncio.Lock()
        self._cleanup_task: Optional[asyncio.Task] = None

    async def start(self):
        """å¯åŠ¨åå°æ¸…ç†ä»»åŠ¡"""
        self._cleanup_task = asyncio.create_task(self._cleanup_loop())

    async def _cleanup_loop(self):
        """å®šæœŸæ¸…ç†è¿‡æœŸä¼šè¯"""
        while True:
            await asyncio.sleep(60)  # æ¯åˆ†é’Ÿæ£€æŸ¥
            await self._cleanup_idle_sessions()

    async def _cleanup_idle_sessions(self):
        """æ¸…ç†ç©ºé—²ä¼šè¯"""
        now = datetime.now()
        async with self._lock:
            expired = [
                sid for sid, session in self._sessions.items()
                if (now - session.last_active).total_seconds() > self.config.idle_timeout_seconds
            ]
            for sid in expired:
                del self._sessions[sid]
                logger.info(f"Released idle session: {sid}")
```

#### 7.2 ç¼“å­˜é…ç½®

```yaml
cache:
  # ä¼šè¯ç©ºé—²è¶…æ—¶ (ç§’)
  idle_timeout_seconds: 600  # 10åˆ†é’Ÿ

  # æœ€å¤§å¹¶å‘ä¼šè¯æ•°
  max_sessions: 50

  # å•ä¸ªä¼šè¯æœ€å¤§æ¶ˆæ¯ç¼“å­˜
  max_messages_per_session: 100

  # å†…å­˜ä½¿ç”¨ä¸Šé™ (MB)
  max_memory_mb: 512

  # æ¸…ç†æ£€æŸ¥é—´éš” (ç§’)
  cleanup_interval_seconds: 60
```

---

### 8. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 8.1 å“åº”å»¶è¿Ÿä¼˜åŒ–

| ç¯èŠ‚ | ä¼˜åŒ–ç­–ç•¥ | é¢„æœŸå»¶è¿Ÿ |
|------|---------|---------|
| æ„å›¾åˆ†æ | ä½¿ç”¨ gemini-2.0-flash-lite | ~200ms |
| çŸ¥è¯†æ£€ç´¢ | ChromaDB æœ¬åœ°å‘é‡æœç´¢ | ~50ms |
| è®°å¿†æ£€ç´¢ | JSON æ–‡ä»¶å†…å­˜ç¼“å­˜ + å…³é”®è¯åŒ¹é… | ~10ms |
| è¯¦ç»†å†å²åŠ è½½ | æŒ‰éœ€åŠ è½½ï¼ŒLRU ç¼“å­˜ | ~20ms |
| ç”Ÿæˆå›å¤ | æµå¼è¾“å‡ºï¼Œé¦– token å¿« | ~500ms |
| **æ€»è®¡** | | **~800ms é¦–å“åº”** |

#### 8.2 ç¼“å­˜ç­–ç•¥

```python
# 1. æ•°æ®ç¼“å­˜ (å¯åŠ¨æ—¶åŠ è½½)
soul_cache = {
    "å‹‡å“¥è¯´è´¢ç»": {
        "system_prompt": "...",
        "chroma_collection": <ChromaCollection>,
        "loaded_at": datetime
    }
}

# 2. ç”¨æˆ· Preview ç¼“å­˜ (LRU)
preview_cache = LRUCache(maxsize=100)  # æœ€å¤šç¼“å­˜ 100 ä¸ªç”¨æˆ·

# 3. ä»Šæ—¥å¯¹è¯ç¼“å­˜ (å†…å­˜)
today_conversations = {
    ("user_id", "soul"): [messages]
}
```

#### 8.3 å¹¶è¡Œå¤„ç†

```python
# çŸ¥è¯†æ£€ç´¢ å’Œ è®°å¿†æ£€ç´¢ å¯å¹¶è¡Œ
async def parallel_search(state):
    results = await asyncio.gather(
        search_soul_knowledge(state),
        search_memory(state)
    )
    return merge_results(results)
```

---

### 9. ç”¨æˆ·ä½“éªŒè®¾è®¡

#### 9.1 æµå¼å“åº”

```
ç”¨æˆ·å‘é€æ¶ˆæ¯
     â”‚
     â–¼
[åˆ†æä¸­...] â† æ˜¾ç¤ºæ€è€ƒçŠ¶æ€ (200ms)
     â”‚
     â–¼
[æ£€ç´¢ç›¸å…³å†…å®¹...] â† æ˜¾ç¤ºæ£€ç´¢çŠ¶æ€ (50ms)
     â”‚
     â–¼
æµå¼è¾“å‡ºæ–‡å­— â† é€å­—æ˜¾ç¤ºå›å¤
     â”‚
     â–¼
[å¼•ç”¨æ¥æº] â† æ˜¾ç¤ºå‚è€ƒçš„è§†é¢‘ç‰‡æ®µ
```

#### 9.2 è®°å¿†å±•ç¤º

å½“ AI ä½¿ç”¨äº†å†å²è®°å¿†æ—¶ï¼Œåœ¨å›å¤ä¸­æ ‡æ³¨ï¼š

```
ğŸ’­ æˆ‘è®°å¾—ä½ ä¹‹å‰è¯´è¿‡...

[æ­£å¸¸å›å¤å†…å®¹]

ğŸ“ å‚è€ƒäº† 2026-02-24 çš„å¯¹è¯
```

#### 9.3 é”™è¯¯å¤„ç†

| åœºæ™¯ | å¤„ç†æ–¹å¼ |
|------|---------|
| LLM è¶…æ—¶ | é‡è¯• 1 æ¬¡ï¼Œä»å¤±è´¥åˆ™è¿”å›å‹å¥½æç¤º |
| æ£€ç´¢æ— ç»“æœ | æ­£å¸¸ç”Ÿæˆï¼Œä¸å¼ºåˆ¶ä½¿ç”¨ä¸Šä¸‹æ–‡ |
| Preview æŸå | è‡ªåŠ¨é‡å»ºï¼Œä¸å½±å“å¯¹è¯ |

---

### 10. API æ¥å£è®¾è®¡

#### 10.1 æ¥å£åˆ—è¡¨

| æ–¹æ³• | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| GET | `/api/soul/status` | æœåŠ¡çŠ¶æ€ |
| GET | `/api/soul/models` | å¯ç”¨æ¨¡å‹åˆ—è¡¨ |
| GET | `/api/soul/souls` | å¯ç”¨åˆ—è¡¨ |
| GET | `/api/soul/users` | ç”¨æˆ·åˆ—è¡¨ |
| POST | `/api/soul/users` | åˆ›å»ºç”¨æˆ· |
| DELETE | `/api/soul/users/{id}` | åˆ é™¤ç”¨æˆ· |
| GET | `/api/soul/history/{user_id}/{soul}` | è·å–å¯¹è¯å†å² |
| POST | `/api/soul/chat` | å‘é€æ¶ˆæ¯ï¼ˆSSE æµå¼ï¼‰ |
| POST | `/api/soul/preview/refresh` | å¼ºåˆ¶åˆ·æ–° Preview |

#### 10.2 Chat æ¥å£è¯¦æƒ…

**è¯·æ±‚**:
```json
POST /api/soul/chat
{
  "user_id": "uuid-xxx",
  "soul": "å‹‡å“¥è¯´è´¢ç»",
  "message": "ä»Šå¤©AIåº”ç”¨æ€ä¹ˆçœ‹ï¼Ÿ",
  "model": "gemini-2.5-flash"
}
```

**å“åº”** (SSE æµå¼):
```
event: thinking
data: {"status": "analyzing"}

event: searching
data: {"status": "searching_knowledge", "query": "AIåº”ç”¨"}

event: token
data: {"content": "å…„"}

event: token
data: {"content": "å¼Ÿ"}

event: token
data: {"content": "ä»¬"}

...

event: done
data: {
  "message_id": "msg-xxx",
  "sources": [
    {"video": "xxx", "segment": 3, "text": "..."}
  ],
  "memory_used": false
}
```

---

### 11. å‰ç«¯é¡µé¢è®¾è®¡ (soul.html)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ§  çµé­‚å¯¹è¯                                           [è®¾ç½®]   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ ğŸ‘¤ å‹‡å“¥è¯´è´¢ç» â–¼â”‚  â”‚ ğŸ™‹ å°æ˜     â–¼â”‚  â”‚ âš¡ 2.5-flashâ–¼â”‚  [+æ–°ç”¨æˆ·]  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚                                                                 â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚â”‚
â”‚  â”‚  â”‚ ğŸ¤– å‹‡å“¥è¯´è´¢ç»                            â”‚                   â”‚â”‚
â”‚  â”‚  â”‚ å…„å¼Ÿä»¬ï¼æ¬¢è¿æ¥æ‰¾å‹‡å“¥èŠå¤©ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å°½ç®¡é—®ï¼â”‚                   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚â”‚
â”‚  â”‚                                                                 â”‚â”‚
â”‚  â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚â”‚
â”‚  â”‚                   â”‚ ä»Šå¤©AIåº”ç”¨æ¿å—æ€ä¹ˆçœ‹ï¼Ÿ                    â”‚  â”‚â”‚
â”‚  â”‚                   â”‚                                    ğŸ™‹ å°æ˜â”‚  â”‚â”‚
â”‚  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”‚
â”‚  â”‚                                                                 â”‚â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚â”‚
â”‚  â”‚  â”‚ ğŸ¤– å‹‡å“¥è¯´è´¢ç»                            â”‚                   â”‚â”‚
â”‚  â”‚  â”‚                                         â”‚                   â”‚â”‚
â”‚  â”‚  â”‚ å…„å¼Ÿä»¬ï¼AIåº”ç”¨è¿™ä¸ªæ–¹å‘ï¼Œå‹‡å“¥è·Ÿä½ ä»¬è¯´ï¼Œ    â”‚                   â”‚â”‚
â”‚  â”‚  â”‚ è¿™æ˜¯2026å¹´æœ€ç¡®å®šçš„ä¸»çº¿ï¼Œæ²¡æœ‰ä¹‹ä¸€ï¼       â”‚                   â”‚â”‚
â”‚  â”‚  â”‚                                         â”‚                   â”‚â”‚
â”‚  â”‚  â”‚ ğŸ“ å‚è€ƒ: AIåº”ç”¨å¼ºåŠ¿å›å½’... (ç‚¹å‡»æŸ¥çœ‹)    â”‚                   â”‚â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚â”‚
â”‚  â”‚                                                                 â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” [å‘é€]    â”‚
â”‚  â”‚ è¾“å…¥æ¶ˆæ¯...                                          â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                     â”‚
â”‚  ğŸ“Š Preview: å·²è®°å¿† 3 å¤©å¯¹è¯ | ğŸ’¬ ä»Šæ—¥: 5 æ¡æ¶ˆæ¯                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 12. é¡¹ç›®æ–‡ä»¶ç»“æ„

```
video-analysis-soul/
â”œâ”€â”€ api/                           # API å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ chat.py               # POST /chat (SSE)
â”‚   â”‚   â”œâ”€â”€ personas.py           # GET /personas, GET /personas/{id}
â”‚   â”‚   â”œâ”€â”€ users.py              # CRUD /users
â”‚   â”‚   â”œâ”€â”€ history.py            # GET /history/{user_id}/{persona}
â”‚   â”‚   â””â”€â”€ system.py             # GET /status, GET /models
â”‚   â”œâ”€â”€ schemas/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ chat.py               # ChatRequest, ChatEvent
â”‚   â”‚   â”œâ”€â”€ persona.py            # PersonaResponse
â”‚   â”‚   â”œâ”€â”€ user.py               # UserCreate, UserResponse
â”‚   â”‚   â””â”€â”€ common.py             # BaseResponse, ErrorResponse
â”‚   â””â”€â”€ middleware/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ error_handler.py      # å…¨å±€å¼‚å¸¸å¤„ç†
â”‚       â””â”€â”€ logging.py            # è¯·æ±‚æ—¥å¿—
â”‚
â”œâ”€â”€ core/                          # æ ¸å¿ƒå±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ engine.py                 # SoulEngine ä¸»å…¥å£
â”‚   â”œâ”€â”€ session.py                # SessionManager
â”‚   â””â”€â”€ graph/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ state.py              # SoulState å®šä¹‰
â”‚       â”œâ”€â”€ workflow.py           # LangGraph æ„å»º
â”‚       â”œâ”€â”€ nodes/
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ load_context.py       # åŠ è½½ä¸Šä¸‹æ–‡
â”‚       â”‚   â”œâ”€â”€ analyze_message.py    # æ„å›¾/æƒ…ç»ªåˆ†æ
â”‚       â”‚   â”œâ”€â”€ route_decision.py     # è·¯ç”±å†³ç­–
â”‚       â”‚   â”œâ”€â”€ greeting_flow.py      # æ‰“æ‹›å‘¼æµç¨‹
â”‚       â”‚   â”œâ”€â”€ knowledge_retrieval.py # çŸ¥è¯†æ£€ç´¢
â”‚       â”‚   â”œâ”€â”€ memory_retrieval.py   # è®°å¿†æ£€ç´¢
â”‚       â”‚   â”œâ”€â”€ load_detail_history.py # åŠ è½½è¯¦ç»†å†å²
â”‚       â”‚   â”œâ”€â”€ generate_response.py  # ç”Ÿæˆå›å¤
â”‚       â”‚   â”œâ”€â”€ post_process.py       # åå¤„ç†
â”‚       â”‚   â””â”€â”€ update_memory.py      # æ›´æ–°è®°å¿†
â”‚       â””â”€â”€ routes.py             # æ¡ä»¶è·¯ç”±å‡½æ•°
â”‚
â”œâ”€â”€ services/                      # æœåŠ¡å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ llm_service.py            # LLM è°ƒç”¨å°è£…
â”‚   â”œâ”€â”€ retrieval_service.py      # çŸ¥è¯†æ£€ç´¢æœåŠ¡
â”‚   â”œâ”€â”€ analysis_service.py       # æ„å›¾/æƒ…ç»ªåˆ†æ
â”‚   â”œâ”€â”€ generation_service.py     # å›å¤ç”Ÿæˆ
â”‚   â””â”€â”€ embedding_service.py      # Embedding æœåŠ¡
â”‚
â”œâ”€â”€ managers/                      # ç®¡ç†å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ persona_manager.py        # Persona ç®¡ç† (ä» maker åŠ è½½)
â”‚   â”œâ”€â”€ user_manager.py           # ç”¨æˆ·ç®¡ç†
â”‚   â”œâ”€â”€ memory_manager.py         # è®°å¿†ç®¡ç†
â”‚   â””â”€â”€ cache_manager.py          # åŠ¨æ€ç¼“å­˜ç®¡ç†
â”‚
â”œâ”€â”€ storage/                       # å­˜å‚¨å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ persona.py            # PersonaMetadata
â”‚   â”‚   â”œâ”€â”€ user.py               # UserProfile
â”‚   â”‚   â”œâ”€â”€ memory.py             # Preview, DailyConversation
â”‚   â”‚   â””â”€â”€ message.py            # Message
â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user_repository.py    # ç”¨æˆ·æ•°æ®è¯»å†™
â”‚   â”‚   â”œâ”€â”€ memory_repository.py  # è®°å¿†æ•°æ®è¯»å†™
â”‚   â”‚   â””â”€â”€ conversation_repository.py # å¯¹è¯æ•°æ®è¯»å†™
â”‚   â””â”€â”€ vector_stores/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ chroma_store.py       # ChromaDB å°è£…
â”‚       â””â”€â”€ faiss_store.py        # FAISS å°è£… (ç”¨æˆ·è®°å¿†)
â”‚
â”œâ”€â”€ common/                        # å…¬å…±å±‚
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py                 # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ logger.py                 # æ—¥å¿—é…ç½®
â”‚   â”œâ”€â”€ exceptions.py             # è‡ªå®šä¹‰å¼‚å¸¸
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ text.py               # æ–‡æœ¬å¤„ç†
â”‚       â”œâ”€â”€ datetime.py           # æ—¶é—´å¤„ç†
â”‚       â””â”€â”€ async_utils.py        # å¼‚æ­¥å·¥å…·
â”‚
â”œâ”€â”€ config/                        # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ settings.yaml             # ä¸»é…ç½®
â”‚   â”œâ”€â”€ prompts/
â”‚   â”‚   â”œâ”€â”€ intent_analysis.txt   # æ„å›¾åˆ†æ Prompt
â”‚   â”‚   â”œâ”€â”€ emotion_detection.txt # æƒ…ç»ªæ£€æµ‹ Prompt
â”‚   â”‚   â”œâ”€â”€ preview_summary.txt   # Preview æ€»ç»“ Prompt
â”‚   â”‚   â””â”€â”€ info_extraction.txt   # ä¿¡æ¯æå– Prompt
â”‚   â””â”€â”€ rules/
â”‚       â”œâ”€â”€ patterns.yaml         # æ„å›¾æ¨¡å¼è§„åˆ™
â”‚       â”œâ”€â”€ emotions.yaml         # æƒ…ç»ªè§¦å‘è¯
â”‚       â””â”€â”€ extraction.yaml       # ä¿¡æ¯æå–è§„åˆ™
â”‚
â”œâ”€â”€ soul_data/                     # è¿è¡Œæ—¶æ•°æ®
â”‚   â””â”€â”€ users/
â”‚       â””â”€â”€ {user_id}/
â”‚           â”œâ”€â”€ profile.json
â”‚           â”œâ”€â”€ preview.json
â”‚           â”œâ”€â”€ relationships.json
â”‚           â”œâ”€â”€ memory_index/     # FAISS ç´¢å¼•
â”‚           â””â”€â”€ conversations/
â”‚               â””â”€â”€ {persona_name}/
â”‚                   â””â”€â”€ {date}.json
â”‚
â”œâ”€â”€ main.py                        # FastAPI å…¥å£
â”œâ”€â”€ requirements.txt               # ä¾èµ–
â”œâ”€â”€ .env.example                   # ç¯å¢ƒå˜é‡æ¨¡æ¿
â””â”€â”€ README.md
```

---

### 13. é…ç½®ç³»ç»Ÿè®¾è®¡

#### 13.1 ç¯å¢ƒå˜é‡ (.env)

```bash
# LLM API
GOOGLE_API_KEY=your_google_api_key

# æœåŠ¡é…ç½®
SOUL_HOST=0.0.0.0
SOUL_PORT=8004
SOUL_DEBUG=false

# è·¯å¾„é…ç½®
MAKER_OUTPUT_PATH=../video-analysis-maker/output
SOUL_DATA_PATH=./soul_data

# æ—¥å¿—
LOG_LEVEL=INFO
LOG_FILE=logs/soul.log
```

#### 13.2 ä¸»é…ç½® (settings.yaml)

```yaml
# Persona é…ç½®
persona:
  maker_output_path: "${MAKER_OUTPUT_PATH:../video-analysis-maker/output}"
  default_persona: null
  knowledge_retrieval:
    top_k: 10
    rerank_top_k: 3
    include_context: true
    context_window: 2

# ç”¨æˆ·è®°å¿†é…ç½®
memory:
  preview:
    retention: permanent          # æ°¸ä¹…ä¿ç•™
    summary_trigger_messages: 10  # æ¯10æ¡æ¶ˆæ¯è§¦å‘æ€»ç»“
  detailed_history:
    retention_days: 14            # ä¿ç•™14å¤©
    archive_enabled: true         # è¶…æœŸå½’æ¡£ï¼ˆä¸åˆ é™¤ï¼‰
  long_term:
    enabled: true
    retention: permanent          # æ°¸ä¹…ä¿ç•™
    max_facts: 200

# ç¼“å­˜é…ç½®
cache:
  idle_timeout_seconds: 600
  max_sessions: 50
  max_messages_per_session: 100
  max_memory_mb: 512
  cleanup_interval_seconds: 60

# LLM æ¨¡å‹é…ç½®
llm:
  default_model: "gemini-2.5-flash"
  analysis_model: "gemini-2.0-flash-lite"
  summary_model: "gemini-2.0-flash"
  available_models:
    - gemini-2.5-flash
    - gemini-2.5-pro
    - gemini-2.0-flash
    - gemini-2.0-flash-lite
  timeout_seconds: 30
  max_retries: 2

# åˆ†æé…ç½®
analysis:
  intent:
    enabled: true
    confidence_threshold: 0.7
  emotion:
    enabled: true
    general_triggers:
      - ["å¼€å¿ƒ", "é«˜å…´", "å…´å¥‹", "æ¿€åŠ¨"]
      - ["éš¾è¿‡", "ä¼¤å¿ƒ", "å¤±è½", "æ²®ä¸§"]
      - ["ç„¦è™‘", "æ‹…å¿ƒ", "ç´§å¼ ", "å®³æ€•"]
      - ["ç”Ÿæ°”", "æ„¤æ€’", "çƒ¦èº", "ä¸æ»¡"]
    response_style:
      positive: "warm"
      negative: "empathetic"
      anxious: "reassuring"
  info_extraction:
    enabled: true
    extract_types:
      - "person_name"
      - "location"
      - "event"
      - "preference"
      - "relationship"

# æµå¼å“åº”é…ç½®
streaming:
  chunk_size: 10
  heartbeat_interval_ms: 15000
```

---

### 14. ä¾èµ–æ¸…å•

```
# requirements.txt
fastapi>=0.109.0
uvicorn>=0.27.0
pydantic>=2.0.0
python-dotenv>=1.0.0

# LangGraph
langgraph>=0.0.40
langchain>=0.1.0
langchain-google-genai>=0.0.9

# å‘é‡æ•°æ®åº“
chromadb>=0.4.22
sentence-transformers>=2.2.2

# å·¥å…·
aiofiles>=23.0.0
cachetools>=5.3.0
```

---

### 15. è®¾è®¡å†³ç­–æ€»è§ˆ (å…¨éƒ¨å·²ç¡®è®¤ âœ…)

| é—®é¢˜ | å†³ç­– | è¯´æ˜ |
|------|------|------|
| Persona æ¥æº | ä» maker è¾“å‡ºåŠ è½½ | ç›´æ¥è¯»å– persona.json å’Œ ChromaDB |
| ç¼“å­˜ç­–ç•¥ | åŠ¨æ€ç®¡ç† | åŸºäºæ´»è·ƒåº¦ï¼Œå¯é…ç½® idle_timeout |
| Persona ç±»å‹ | é€šç”¨åŒ– | æ”¯æŒç½‘çº¢ã€æ˜æ˜Ÿã€ä¸“å®¶ã€è™šæ‹Ÿè§’è‰²ç­‰ |
| æƒ…ç»ªæ£€æµ‹ | é¢†åŸŸæ— å…³ | é€šç”¨è§¦å‘è¯ + é¢†åŸŸå¢å¼º |
| ä¿¡æ¯æå– | é¢†åŸŸæ— å…³ | é€šç”¨ç±»å‹ + é¢†åŸŸå¢å¼º |
| LLM æ¨¡å‹ | å¤šå±‚çº§ | ä¸åŒä»»åŠ¡ç”¨ä¸åŒæ¨¡å‹ |
| Preview å­˜å‚¨ | JSON + FAISS | æ”¯æŒè¯­ä¹‰æœç´¢ |
| è®°å¿†ä¿ç•™ | åˆ†å±‚æ°¸ä¹…ä¿ç•™ | è¯¦ç»†14å¤©ï¼ŒPreviewæ°¸ä¹…ï¼Œé•¿æœŸè®°å¿†æ°¸ä¹… |
| è®°å¿†éš”ç¦» | éƒ¨åˆ†å…±äº« | ç”¨æˆ·ä¿¡æ¯å…±äº«ï¼Œå¯¹è¯æŒ‰Personaéš”ç¦» |
| æ‰“æ‹›å‘¼ | åŠ¨æ€+é£æ ¼æ¨¡æ¿ | åŸºäºç™»å½•æ—¶é—´åŠ¨æ€åé¦ˆ |
| é”™è¯¯æ¢å¤ | é™çº§+æ—¥å¿— | é™çº§åˆ°è½»é‡æ¨¡å‹ï¼Œå®Œå–„æ—¥å¿—ç³»ç»Ÿ |
| å‰ç«¯äº¤äº’ | ç±»äººè¯æœ¯ | æŠ˜å å±•å¼€ï¼Œé…ç½®é¡¹æ§åˆ¶è°ƒè¯•ä¿¡æ¯ |
| æµ‹è¯•ç­–ç•¥ | é™¤å‰ç«¯å¤–å…¨è¦†ç›– | mock + çœŸå®ç¯å¢ƒä¸¤ç§ |
| éƒ¨ç½² | Docker + å¤šå®ä¾‹ | JSONæ—¥å¿—æ ¼å¼ |

---

### 16. è®°å¿†ä¿ç•™ç­–ç•¥è¯¦ç»†è®¾è®¡

#### 16.1 è®°å¿†å±‚çº§

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        è®°å¿†é‡‘å­—å¡”                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚   é•¿æœŸè®°å¿†       â”‚  â† æ°¸ä¹…ä¿ç•™ï¼Œæ ¸å¿ƒäº‹å®                      â”‚
â”‚    â”‚ (long_term)     â”‚    ç”¨æˆ·å§“åã€èŒä¸šã€é‡è¦å…³ç³»ã€æ ¸å¿ƒåå¥½        â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚             â”‚                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚   Preview æ€»ç»“   â”‚  â† æ°¸ä¹…ä¿ç•™ï¼Œæ¯æ—¥/æ¯å‘¨æ€»ç»“                 â”‚
â”‚    â”‚ (preview)       â”‚    å¯åŸºäº Preview è¿›ä¸€æ­¥æŠ½è±¡æ¦‚æ‹¬            â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚             â”‚                                                   â”‚
â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                          â”‚
â”‚    â”‚   è¯¦ç»†å¯¹è¯       â”‚  â† ä¿ç•™ 14 å¤©ï¼Œè¶…æœŸå½’æ¡£                    â”‚
â”‚    â”‚ (conversations) â”‚    å®Œæ•´å¯¹è¯è®°å½•ï¼Œæ”¯æŒå›æº¯                   â”‚
â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 16.2 æ•°æ®ç”Ÿå‘½å‘¨æœŸ

| æ•°æ®ç±»å‹ | ä¿ç•™æœŸé™ | è¶…æœŸå¤„ç† | å­˜å‚¨ä½ç½® |
|----------|----------|----------|----------|
| è¯¦ç»†å¯¹è¯ | 14 å¤© | å½’æ¡£åˆ° archive/ | conversations/{persona}/{date}.json |
| Preview æ€»ç»“ | æ°¸ä¹… | ä¸åˆ é™¤ | preview.json |
| é•¿æœŸè®°å¿† | æ°¸ä¹… | ä¸åˆ é™¤ | long_term_memory.json |
| å½’æ¡£å¯¹è¯ | æ°¸ä¹… | å‹ç¼©å­˜å‚¨ | archive/{persona}/{year-month}.json.gz |

#### 16.3 ç”¨æˆ·æ•°æ®ç»“æ„ï¼ˆæ›´æ–°ï¼‰

```
soul_data/users/{user_id}/
â”œâ”€â”€ profile.json              # å…±äº«ï¼šç”¨æˆ·åŸºæœ¬ä¿¡æ¯
â”œâ”€â”€ relationships.json        # å…±äº«ï¼šäººç‰©å…³ç³»ç½‘ç»œ
â”œâ”€â”€ long_term_memory.json     # å…±äº«ï¼šæ ¸å¿ƒäº‹å®ï¼ˆæ°¸ä¹…ï¼‰
â”œâ”€â”€ memory_index/             # å…±äº«ï¼šFAISS å‘é‡ç´¢å¼•
â”‚   â””â”€â”€ user_memory.faiss
â”œâ”€â”€ conversations/            # éš”ç¦»ï¼šæŒ‰ Persona åˆ†å¼€
â”‚   â””â”€â”€ {persona_name}/
â”‚       â”œâ”€â”€ preview.json      # è¯¥ Persona çš„å¯¹è¯æ€»ç»“ï¼ˆæ°¸ä¹…ï¼‰
â”‚       â”œâ”€â”€ 2026-02-25.json   # å½“å¤©è¯¦ç»†å¯¹è¯
â”‚       â”œâ”€â”€ 2026-02-24.json   # æ˜¨å¤©è¯¦ç»†å¯¹è¯
â”‚       â””â”€â”€ ...               # æœ€å¤šä¿ç•™ 14 å¤©
â””â”€â”€ archive/                  # éš”ç¦»ï¼šå½’æ¡£çš„å†å²å¯¹è¯
    â””â”€â”€ {persona_name}/
        â”œâ”€â”€ 2026-01.json.gz   # æŒ‰æœˆå‹ç¼©å½’æ¡£
        â””â”€â”€ 2025-12.json.gz
```

#### 16.4 å½’æ¡£ä»»åŠ¡

```python
class ArchiveManager:
    """å¯¹è¯å½’æ¡£ç®¡ç†å™¨"""

    async def archive_expired_conversations(self, user_id: str):
        """å½’æ¡£è¶…è¿‡14å¤©çš„å¯¹è¯"""
        cutoff_date = datetime.now() - timedelta(days=14)

        for persona_dir in self._get_persona_dirs(user_id):
            for conv_file in persona_dir.glob("*.json"):
                file_date = self._parse_date_from_filename(conv_file)
                if file_date < cutoff_date:
                    await self._archive_to_monthly(conv_file, persona_dir)
                    conv_file.unlink()  # åˆ é™¤åŸæ–‡ä»¶

    async def _archive_to_monthly(self, conv_file: Path, persona_dir: Path):
        """å‹ç¼©å½’æ¡£åˆ°æœˆåº¦æ–‡ä»¶"""
        archive_dir = persona_dir.parent.parent / "archive" / persona_dir.name
        archive_dir.mkdir(parents=True, exist_ok=True)

        year_month = conv_file.stem[:7]  # 2026-02
        archive_file = archive_dir / f"{year_month}.json.gz"

        # è¿½åŠ åˆ°å‹ç¼©æ–‡ä»¶
        # ...
```

---

### 17. æ‰“æ‹›å‘¼æœºåˆ¶è¯¦ç»†è®¾è®¡

#### 17.1 æ‰“æ‹›å‘¼ç­–ç•¥

| ç”¨æˆ·çŠ¶æ€ | ç­–ç•¥ | ç¤ºä¾‹ |
|----------|------|------|
| æ–°ç”¨æˆ·é¦–æ¬¡ | ä¸»åŠ¨æ¬¢è¿ + è‡ªæˆ‘ä»‹ç» | "å…„å¼Ÿä»¬ï¼æ¬¢è¿æ¥åˆ°å‹‡å“¥çš„ç›´æ’­é—´ï¼" |
| ä»Šæ—¥é¦–æ¬¡ï¼ˆ<24hï¼‰ | ç®€çŸ­é—®å€™ | "åˆè§é¢äº†ï¼ä»Šå¤©æƒ³èŠç‚¹ä»€ä¹ˆï¼Ÿ" |
| éš”å¤©å›å½’ï¼ˆ1-3å¤©ï¼‰ | å…³å¿ƒ + å›é¡¾ | "è¿™ä¸¤å¤©æ²¡è§ï¼Œæœ‰æ²¡æœ‰å…³æ³¨AIæ¿å—çš„èµ°åŠ¿ï¼Ÿ" |
| é•¿æ—¶é—´æœªç™»å½•ï¼ˆ>7å¤©ï¼‰ | çƒ­æƒ… + æ¨è | "å¥½ä¹…æ²¡èŠäº†ï¼æœ€è¿‘å¸‚åœºæœ‰äº›æ–°åŠ¨å‘..." |

#### 17.2 åŠ¨æ€å†…å®¹ç”Ÿæˆ

```python
class GreetingGenerator:
    """æ‰“æ‹›å‘¼ç”Ÿæˆå™¨"""

    async def generate_greeting(
        self,
        persona: PersonaMetadata,
        user: UserProfile,
        last_session: Optional[datetime]
    ) -> str:
        """ç”Ÿæˆä¸ªæ€§åŒ–æ‰“æ‹›å‘¼å†…å®¹"""

        # 1. è®¡ç®—è·ç¦»ä¸Šæ¬¡å¯¹è¯çš„æ—¶é—´
        absence_category = self._categorize_absence(last_session)

        # 2. è·å–æ¨èè¯é¢˜ï¼ˆåŸºäºç”¨æˆ·åå¥½ + Persona çŸ¥è¯†åº“æœ€æ–°å†…å®¹ï¼‰
        recommendations = await self._get_recommendations(persona, user)

        # 3. é€‰æ‹©æ‰“æ‹›å‘¼æ¨¡æ¿
        template = self._select_template(persona, absence_category)

        # 4. å¡«å……åŠ¨æ€å†…å®¹
        greeting = template.format(
            user_name=user.name or "æœ‹å‹",
            absence_desc=self._get_absence_desc(absence_category),
            recommendations=recommendations,
            persona_catchphrase=random.choice(persona.common_phrases)
        )

        return greeting

    def _categorize_absence(self, last_session: Optional[datetime]) -> str:
        if last_session is None:
            return "new_user"

        hours = (datetime.now() - last_session).total_seconds() / 3600
        if hours < 24:
            return "same_day"
        elif hours < 72:
            return "short_absence"
        else:
            return "long_absence"
```

#### 17.3 Persona é£æ ¼æ¨¡æ¿

```yaml
# config/prompts/greetings/{persona_id}.yaml

new_user:
  - "å„ä½ç²‰ä¸æœ‹å‹ä»¬ï¼Œ{user_name}ä½ å¥½ï¼æ¬¢è¿æ¥æ‰¾å‹‡å“¥èŠå¤©ï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å°½ç®¡é—®ï¼"
  - "å…„å¼Ÿä»¬ï¼æ–°æœ‹å‹æ¥äº†ï¼{user_name}ï¼Œè·Ÿç€å‹‡å“¥åƒå¤§è‚‰ï¼"

same_day:
  - "åˆè§é¢äº†{user_name}ï¼è¿˜æœ‰ä»€ä¹ˆæƒ³é—®çš„ï¼Ÿ"
  - "{user_name}ï¼Œåˆšæ‰èŠçš„è¿˜æ²¡è¿‡ç˜¾ï¼Ÿç»§ç»­ï¼"

short_absence:
  - "{user_name}ï¼Œè¿™ä¸¤å¤©æ²¡è§ï¼Œ{recommendations}ï¼Œè¦ä¸è¦èŠèŠï¼Ÿ"
  - "å…„å¼Ÿï¼{absence_desc}ï¼Œå¸‚åœºåˆæœ‰æ–°åŠ¨å‘äº†ï¼"

long_absence:
  - "{user_name}ï¼å¥½ä¹…æ²¡è§äº†ï¼æœ€è¿‘{recommendations}ï¼Œå‹‡å“¥æœ‰è¯è¦è¯´ï¼"
  - "å…„å¼Ÿä»¬ï¼{user_name}å›æ¥äº†ï¼è¿™æ®µæ—¶é—´é”™è¿‡ä¸å°‘ï¼Œå‹‡å“¥ç»™ä½ è¡¥è¡¥è¯¾ï¼"
```

---

### 18. é”™è¯¯æ¢å¤ä¸æ—¥å¿—ç³»ç»Ÿ

#### 18.1 é”™è¯¯å¤„ç†ç­–ç•¥

```python
class ErrorHandler:
    """ç»Ÿä¸€é”™è¯¯å¤„ç†å™¨"""

    async def handle_llm_error(self, error: Exception, context: dict) -> str:
        """LLM è°ƒç”¨å¤±è´¥å¤„ç†"""
        logger.error(f"LLM error: {error}", extra=context)

        # 1. é‡è¯•ä¸€æ¬¡
        try:
            return await self._retry_with_same_model(context)
        except Exception:
            pass

        # 2. é™çº§åˆ°è½»é‡æ¨¡å‹
        try:
            return await self._fallback_to_lite_model(context)
        except Exception:
            pass

        # 3. è¿”å›å›ºå®šè¯æœ¯
        return self._get_fallback_response(context.get("persona"))

    async def handle_chromadb_error(self, error: Exception, context: dict) -> list:
        """ChromaDB è¿æ¥å¤±è´¥å¤„ç†"""
        logger.error(f"ChromaDB error: {error}", extra=context)

        # è·³è¿‡çŸ¥è¯†æ£€ç´¢ï¼Œè¿”å›ç©ºç»“æœ
        return []

    async def handle_data_corruption(self, error: Exception, file_path: Path) -> None:
        """æ•°æ®æ–‡ä»¶æŸåå¤„ç†"""
        logger.critical(f"Data corruption: {file_path}", exc_info=error)

        # 1. å¤‡ä»½æŸåæ–‡ä»¶
        backup_path = file_path.with_suffix(f".corrupted.{datetime.now().strftime('%Y%m%d%H%M%S')}")
        shutil.move(file_path, backup_path)

        # 2. å°è¯•è‡ªåŠ¨é‡å»º
        await self._rebuild_data_file(file_path)
```

#### 18.2 æ—¥å¿—ç³»ç»Ÿè®¾è®¡

```python
# common/logger.py

import logging
import json
from datetime import datetime

class JSONFormatter(logging.Formatter):
    """JSON æ ¼å¼æ—¥å¿—"""

    def format(self, record):
        log_data = {
            "timestamp": datetime.utcnow().isoformat(),
            "level": record.levelname,
            "logger": record.name,
            "message": record.getMessage(),
            "module": record.module,
            "function": record.funcName,
            "line": record.lineno,
        }

        # æ·»åŠ é¢å¤–ä¸Šä¸‹æ–‡
        if hasattr(record, "user_id"):
            log_data["user_id"] = record.user_id
        if hasattr(record, "persona"):
            log_data["persona"] = record.persona
        if hasattr(record, "request_id"):
            log_data["request_id"] = record.request_id
        if record.exc_info:
            log_data["exception"] = self.formatException(record.exc_info)

        return json.dumps(log_data, ensure_ascii=False)

def setup_logging(config: LogConfig):
    """é…ç½®æ—¥å¿—ç³»ç»Ÿ"""
    root_logger = logging.getLogger()
    root_logger.setLevel(config.level)

    # æ§åˆ¶å°è¾“å‡º
    console_handler = logging.StreamHandler()
    console_handler.setFormatter(JSONFormatter())
    root_logger.addHandler(console_handler)

    # æ–‡ä»¶è¾“å‡ºï¼ˆæŒ‰æ—¥æœŸè½®è½¬ï¼‰
    file_handler = TimedRotatingFileHandler(
        config.file_path,
        when="midnight",
        interval=1,
        backupCount=30,
        encoding="utf-8"
    )
    file_handler.setFormatter(JSONFormatter())
    root_logger.addHandler(file_handler)
```

#### 18.3 æ—¥å¿—é…ç½®

```yaml
# config/settings.yaml

logging:
  level: INFO
  file_path: logs/soul.log
  backup_count: 30

  # ç‰¹å®šæ¨¡å—æ—¥å¿—çº§åˆ«
  module_levels:
    llm_service: DEBUG
    chroma_store: DEBUG
    cache_manager: INFO

  # æ•æ„Ÿä¿¡æ¯è„±æ•
  redact_fields:
    - api_key
    - password
    - token
```

#### 18.4 å¤‡ä»½ç­–ç•¥

```yaml
# config/settings.yaml

backup:
  enabled: true
  schedule: "0 2 * * *"  # æ¯å¤©å‡Œæ™¨2ç‚¹
  retention_days: 30

  # å¤‡ä»½å†…å®¹
  include:
    - soul_data/users/
    - config/

  # å¤‡ä»½ä½ç½®
  destination: backups/

  # å‹ç¼©
  compression: gzip
```

---

### 19. å‰ç«¯äº¤äº’è¯¦ç»†è®¾è®¡

#### 19.1 çŠ¶æ€è¯æœ¯é…ç½®

```yaml
# config/ui/status_phrases.yaml

thinking:
  - "è®©æˆ‘æƒ³æƒ³..."
  - "å—¯ï¼Œè¿™ä¸ªé—®é¢˜..."
  - "ç¨ç­‰ï¼Œæˆ‘æ•´ç†ä¸€ä¸‹æ€è·¯..."

searching:
  - "é‚£ä¸ª...åº”è¯¥æ˜¯..."
  - "å—¯...è®©æˆ‘æ‰¾æ‰¾..."
  - "ç­‰ç­‰ï¼Œæˆ‘è®°å¾—æœ‰ç›¸å…³å†…å®¹..."

generating:
  - ""  # ç”Ÿæˆæ—¶ä¸æ˜¾ç¤ºé¢å¤–è¯æœ¯ï¼Œç›´æ¥è¾“å‡ºå†…å®¹
```

#### 19.2 å¼•ç”¨æ¥æºå±•ç¤º

```html
<!-- æŠ˜å å±•å¼€ç»„ä»¶ -->
<div class="source-reference">
  <button @click="expanded = !expanded" class="source-toggle">
    ğŸ“ å‚è€ƒæ¥æº ({{ sources.length }})
    <span v-if="!expanded">å±•å¼€</span>
    <span v-else>æ”¶èµ·</span>
  </button>

  <div v-show="expanded" class="source-list">
    <div v-for="source in sources" class="source-item">
      <div class="source-title">{{ source.video_title }}</div>
      <div class="source-text">{{ source.text }}</div>
      <div class="source-meta">
        ç‰‡æ®µ {{ source.segment }} | ç›¸å…³åº¦ {{ (1 - source.distance).toFixed(2) }}
      </div>
    </div>
  </div>
</div>
```

#### 19.3 è°ƒè¯•ä¿¡æ¯é…ç½®

```yaml
# config/settings.yaml

ui:
  debug:
    # æ˜¯å¦æ˜¾ç¤ºè®°å¿†ä½¿ç”¨æ ‡æ³¨ï¼ˆå¼€å‘æ—¶æ‰“å¼€ï¼Œç”Ÿäº§ç¯å¢ƒå…³é—­ï¼‰
    show_memory_usage: true

    # æ˜¯å¦æ˜¾ç¤ºæ£€ç´¢è¯¦æƒ…
    show_retrieval_details: true

    # æ˜¯å¦æ˜¾ç¤ºæ„å›¾åˆ†æç»“æœ
    show_intent_analysis: true
```

```html
<!-- è°ƒè¯•ä¿¡æ¯å±•ç¤ºï¼ˆä»… debug æ¨¡å¼ï¼‰ -->
<div v-if="debugMode && message.debug" class="debug-info">
  <div class="debug-section">
    <span class="debug-label">æ„å›¾:</span>
    <span class="debug-value">{{ message.debug.intent }}</span>
  </div>
  <div class="debug-section" v-if="message.debug.memory_used">
    <span class="debug-label">ğŸ’­ ä½¿ç”¨äº†å†å²è®°å¿†</span>
  </div>
</div>
```

---

### 20. æµ‹è¯•ç­–ç•¥è¯¦ç»†è®¾è®¡

#### 20.1 æµ‹è¯•è¦†ç›–èŒƒå›´

| å±‚çº§ | æ¨¡å— | æµ‹è¯•ç±»å‹ | è¯´æ˜ |
|------|------|----------|------|
| managers | PersonaManager | å•å…ƒæµ‹è¯• | åŠ è½½ã€ç¼“å­˜ã€æœç´¢ |
| managers | UserManager | å•å…ƒæµ‹è¯• | CRUDã€éªŒè¯ |
| managers | MemoryManager | å•å…ƒæµ‹è¯• | Previewã€å½’æ¡£ |
| managers | CacheManager | å•å…ƒæµ‹è¯• | åŠ¨æ€é‡Šæ”¾ã€LRU |
| services | LLMService | é›†æˆæµ‹è¯• | mock + çœŸå® |
| services | RetrievalService | é›†æˆæµ‹è¯• | ChromaDB æŸ¥è¯¢ |
| services | AnalysisService | å•å…ƒæµ‹è¯• | æ„å›¾ã€æƒ…ç»ªæ£€æµ‹ |
| core/graph | å„èŠ‚ç‚¹ | å•å…ƒæµ‹è¯• | çŠ¶æ€è½¬æ¢ |
| core/graph | å®Œæ•´å·¥ä½œæµ | é›†æˆæµ‹è¯• | ç«¯åˆ°ç«¯ |
| storage | Repositories | å•å…ƒæµ‹è¯• | è¯»å†™ã€éªŒè¯ |
| api | Routes | é›†æˆæµ‹è¯• | è¯·æ±‚å“åº” |

#### 20.2 æµ‹è¯•é…ç½®

```python
# tests/conftest.py

import pytest
from unittest.mock import AsyncMock

@pytest.fixture
def mock_llm_service():
    """Mock LLM æœåŠ¡"""
    service = AsyncMock()
    service.generate.return_value = "è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„å›å¤"
    service.analyze_intent.return_value = {
        "intent": "question",
        "confidence": 0.9
    }
    return service

@pytest.fixture
def real_llm_service():
    """çœŸå® LLM æœåŠ¡ï¼ˆéœ€è¦ API Keyï¼‰"""
    from services.llm_service import LLMService
    return LLMService()

# ä½¿ç”¨æ ‡è®°åŒºåˆ†æµ‹è¯•ç±»å‹
# pytest -m "not real_llm"  # åªè¿è¡Œ mock æµ‹è¯•
# pytest -m "real_llm"      # åªè¿è¡ŒçœŸå® LLM æµ‹è¯•
```

#### 20.3 æ€§èƒ½åŸºå‡†

```python
# tests/performance/test_response_time.py

import pytest
import time

@pytest.mark.performance
async def test_first_response_time(soul_engine, sample_request):
    """é¦–å“åº”æ—¶é—´åº”åœ¨ 1-3 ç§’å†…"""
    start = time.time()

    async for event in soul_engine.chat(sample_request):
        if event.type == "token":
            first_token_time = time.time() - start
            break

    assert first_token_time < 3.0, f"é¦–å“åº”æ—¶é—´ {first_token_time:.2f}s è¶…è¿‡ 3s"
```

---

### 21. éƒ¨ç½²é…ç½®

#### 21.1 Dockerfile

```dockerfile
FROM python:3.11-slim

WORKDIR /app

# å®‰è£…ä¾èµ–
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶ä»£ç 
COPY . .

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p soul_data logs

# æš´éœ²ç«¯å£
EXPOSE 8004

# å¯åŠ¨å‘½ä»¤
CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8004"]
```

#### 21.2 docker-compose.yml

```yaml
version: '3.8'

services:
  soul:
    build: .
    ports:
      - "8004:8004"
    volumes:
      - ./soul_data:/app/soul_data
      - ./logs:/app/logs
      - ../video-analysis-maker/output:/app/maker_output:ro
    environment:
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - MAKER_OUTPUT_PATH=/app/maker_output
      - LOG_LEVEL=INFO
    restart: unless-stopped

    # å¤šå®ä¾‹éƒ¨ç½²
    deploy:
      replicas: 2
      resources:
        limits:
          memory: 2G
```

#### 21.3 å¤šå®ä¾‹æ³¨æ„äº‹é¡¹

```yaml
# config/settings.yaml

deployment:
  # å®ä¾‹æ ‡è¯†ï¼ˆç”¨äºæ—¥å¿—åŒºåˆ†ï¼‰
  instance_id: "${HOSTNAME:soul-1}"

  # å…±äº«å­˜å‚¨
  # å¤šå®ä¾‹æ—¶ soul_data éœ€è¦ä½¿ç”¨å…±äº«å­˜å‚¨ï¼ˆNFS/S3ï¼‰
  storage:
    type: local  # local | nfs | s3

  # ç¼“å­˜åŒæ­¥
  # å¤šå®ä¾‹æ—¶éœ€è¦è€ƒè™‘ç¼“å­˜ä¸€è‡´æ€§
  cache:
    # å¯é€‰ï¼šä½¿ç”¨ Redis ä½œä¸ºå…±äº«ç¼“å­˜
    backend: memory  # memory | redis
```

---

## ä¸‹ä¸€æ­¥

1. [x] ~~ç¡®è®¤å¾…ç¡®è®¤é—®é¢˜ (Q1-Q8)~~ âœ… å…¨éƒ¨ç¡®è®¤
2. [ ] åˆ›å»ºé¡¹ç›®éª¨æ¶ (ç›®å½•ç»“æ„)
3. [ ] å®ç° PersonaManager (ä» maker åŠ è½½)
4. [ ] å®ç° LangGraph å·¥ä½œæµ
5. [ ] å®ç°ç”¨æˆ·/è®°å¿†ç®¡ç†
6. [ ] å®ç° API å±‚
7. [ ] å®ç°å‰ç«¯é¡µé¢ (soul.html)
8. [ ] æµ‹è¯•å’Œä¼˜åŒ–

---

## è®¾è®¡å®Œæˆåº¦

| æ¨¡å— | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| ç³»ç»Ÿæ¶æ„ | âœ… å®Œæˆ | æ•´ä½“æ¶æ„å›¾å·²ç¡®å®š |
| Persona ç³»ç»Ÿ | âœ… å®Œæˆ | ä» maker åŠ è½½ï¼Œæ”¯æŒå¤šç±»å‹ |
| æ•°æ®å­˜å‚¨ | âœ… å®Œæˆ | ç›®å½•ç»“æ„å’Œæ•°æ®æ¨¡å‹å·²å®šä¹‰ |
| LangGraph å·¥ä½œæµ | âœ… å®Œæˆ | çŠ¶æ€ã€èŠ‚ç‚¹ã€è·¯ç”±å·²è®¾è®¡ |
| Preview æœºåˆ¶ | âœ… å®Œæˆ | è§¦å‘æ—¶æœºå’Œ Prompt å·²å®šä¹‰ |
| åŠ¨æ€ç¼“å­˜ | âœ… å®Œæˆ | SessionCacheManager å·²è®¾è®¡ |
| é…ç½®ç³»ç»Ÿ | âœ… å®Œæˆ | ç¯å¢ƒå˜é‡å’Œ YAML é…ç½®å·²å®šä¹‰ |
| API æ¥å£ | âœ… å®Œæˆ | æ¥å£åˆ—è¡¨å’Œ SSE æ ¼å¼å·²å®šä¹‰ |
| é¡¹ç›®ç»“æ„ | âœ… å®Œæˆ | è¯¦ç»†ç›®å½•ç»“æ„å·²å®šä¹‰ |
| å‰ç«¯é¡µé¢ | âœ… å®Œæˆ | UI å¸ƒå±€å·²è®¾è®¡ |
| è®°å¿†ä¿ç•™ç­–ç•¥ | âœ… å®Œæˆ | 14å¤©è¯¦ç»†+æ°¸ä¹…Preview+æ°¸ä¹…é•¿æœŸ |
| æ‰“æ‹›å‘¼æœºåˆ¶ | âœ… å®Œæˆ | åŠ¨æ€åé¦ˆ+Personaé£æ ¼æ¨¡æ¿ |
| é”™è¯¯æ¢å¤ | âœ… å®Œæˆ | é™çº§ç­–ç•¥+æ—¥å¿—ç³»ç»Ÿ+å¤‡ä»½ |
| æµ‹è¯•ç­–ç•¥ | âœ… å®Œæˆ | é™¤å‰ç«¯å¤–å…¨è¦†ç›–ï¼Œmock+çœŸå® |
| éƒ¨ç½²é…ç½® | âœ… å®Œæˆ | Docker+å¤šå®ä¾‹+JSONæ—¥å¿— |
| è¿æ¥åŠ©æ‰‹ | âœ… å®Œæˆ | åŒ¿åç”¨æˆ·å…³ç³»å»ºç«‹+åå¥½æ”¶é›†+æ³¨å†Œå¼•å¯¼ |
| Auth è®¤è¯ | âœ… å®Œæˆ | åŒ¿å/æ³¨å†Œ/å£ä»¤/å°ç§˜å¯†éªŒè¯ |

---

## Connection Agentï¼ˆè¿æ¥åŠ©æ‰‹ï¼‰è®¾è®¡

### æ¦‚è¿°

è¿æ¥åŠ©æ‰‹æ˜¯ä¸€ä¸ªé’ˆå¯¹åŒ¿åç”¨æˆ·çš„å…³ç³»å»ºç«‹ç³»ç»Ÿã€‚å½“åŒ¿åç”¨æˆ·ä¸å¯¹è¯æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ”¹å†™å›å¤ï¼Œèå…¥å…³ç³»å»ºç«‹å…ƒç´ ï¼Œé€æ­¥æ”¶é›†ç”¨æˆ·ç”»åƒï¼Œå¹¶åœ¨é€‚å½“æ—¶æœºæ¸©æŸ”å¼•å¯¼æ³¨å†Œã€‚

### å·¥ä½œæµå˜æ›´

```
æ—§: generate/greeting â†’ post_process â†’ update_memory â†’ END
æ–°: generate/greeting â†’ connection_rewrite â†’ post_process â†’ extract_preferences â†’ update_memory â†’ END
```

### æ–°å¢èŠ‚ç‚¹

#### connection_rewriteï¼ˆè¿æ¥æ”¹å†™ï¼‰

- **ä½ç½®**ï¼šgenerate/greeting ä¹‹åï¼Œpost_process ä¹‹å‰
- **è§¦å‘æ¡ä»¶**ï¼šä»…åŒ¿åç”¨æˆ·ï¼ˆis_anonymous=Trueï¼‰
- **é€»è¾‘**ï¼š
  1. ä» user_preferences.collection_progress è®¡ç®—è¿˜æœªæ”¶é›†çš„ç»´åº¦
  2. é€‰æ‹©æœ¬è½®ç›®æ ‡ç»´åº¦ï¼ˆæŒ‰é¡ºåºå–ç¬¬ä¸€ä¸ªæœªæ”¶é›†çš„ï¼‰
  3. ä½¿ç”¨ connection_agent.txt prompt æ¨¡æ¿è°ƒç”¨ LLM æ”¹å†™å›å¤
  4. ä¿æŒäººè®¾å’Œé£æ ¼ï¼Œè‡ªç„¶è¿½åŠ æ¢ç´¢æ€§å…ƒç´ 
  5. è¶…è¿‡ nudge_threshold è½®åï¼Œæ¸©æŸ”æç¤ºæ³¨å†Œ
- **å¤±è´¥å¤„ç†**ï¼šä¿ç•™åŸå§‹å›å¤ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
- **æ³¨å†Œç”¨æˆ·**ï¼šç›´æ¥ return {}ï¼ˆNO-OPï¼‰

#### extract_preferencesï¼ˆåå¥½æå–ï¼‰

- **ä½ç½®**ï¼špost_process ä¹‹åï¼Œupdate_memory ä¹‹å‰
- **è§¦å‘æ¡ä»¶**ï¼šä»…åŒ¿åç”¨æˆ·ï¼Œä¸”æ¯ 3 è½®æå–ä¸€æ¬¡ï¼ˆç¬¬ 2 è½®ä¹Ÿæå–ï¼‰
- **é€»è¾‘**ï¼š
  1. è°ƒç”¨ LLM ä»æœ€è¿‘ 12 æ¡æ¶ˆæ¯ä¸­æå–åå¥½ JSON
  2. é€šè¿‡ PreferencesRepository.merge_from_conversation() åˆå¹¶ä¿å­˜
  3. æ”¯æŒçš„ç»´åº¦ï¼šinterests, visit_motivation, personality_type, communication_style, recent_topics, knowledge_level
- **å­˜å‚¨ä½ç½®**ï¼š`soul_data/users/{user_id}/preferences.json`

### æ–°å¢é…ç½®

```yaml
# config/settings.yaml
connection_agent:
  enabled: true           # æ˜¯å¦å¯ç”¨è¿æ¥åŠ©æ‰‹
  nudge_threshold: 5      # å¤šå°‘è½®åå¼€å§‹å¼•å¯¼æ³¨å†Œ
  dimensions:             # éœ€è¦æ”¶é›†çš„ç”¨æˆ·ç”»åƒç»´åº¦
    - interests
    - visit_motivation
    - personality_type
    - communication_style
    - recent_topics
```

### LLM è°ƒç”¨å¼€é”€

| ç”¨æˆ·ç±»å‹ | connection_rewrite | extract_preferences | å¹³å‡é¢å¤–è°ƒç”¨/è½® |
|----------|-------------------|-------------------|----------------|
| åŒ¿åç”¨æˆ· | æ¯è½® 1 æ¬¡ | æ¯ 3 è½® 1 æ¬¡ | ~1.33 |
| æ³¨å†Œç”¨æˆ· | 0ï¼ˆNO-OPï¼‰ | 0ï¼ˆNO-OPï¼‰ | 0 |

å…¨éƒ¨ä½¿ç”¨ analysis_modelï¼ˆgemini-2.5-flashï¼‰ï¼Œæœ€ä½æˆæœ¬ã€‚

### æ–°å¢æ–‡ä»¶

```
core/graph/nodes/connection_rewrite.py    # è¿æ¥æ”¹å†™èŠ‚ç‚¹
core/graph/nodes/extract_preferences.py   # åå¥½æå–èŠ‚ç‚¹
config/prompts/connection_agent.txt       # è¿æ¥åŠ©æ‰‹ prompt æ¨¡æ¿
storage/models/preferences.py             # ç”¨æˆ·åå¥½æ¨¡å‹
storage/repositories/preferences_repository.py  # åå¥½ä»“åº“
```

### ä¿®æ”¹æ–‡ä»¶

```
common/config.py              # æ–°å¢ ConnectionAgentConfig
core/graph/state.py           # æ–°å¢ turn_count å­—æ®µ
core/graph/nodes/load_context.py  # åŠ è½½åŒ¿åçŠ¶æ€å’Œåå¥½
core/graph/workflow.py        # æ³¨å†Œæ–°èŠ‚ç‚¹ï¼Œé‡æ–°å¸ƒçº¿
core/engine.py                # æ³¨å…¥ PreferencesRepository
```

### æ•°æ®æµ

```
1. load_context: åŠ è½½ is_anonymous, user_preferences, turn_count
2. generate/greeting: ç”ŸæˆåŸå§‹å›å¤
3. connection_rewrite: (åŒ¿å) ç”¨ connection_agent prompt æ”¹å†™å›å¤
4. post_process: ä¿å­˜æ¶ˆæ¯ï¼ˆåŒ…å«æ”¹å†™åçš„å›å¤ï¼‰
5. extract_preferences: (åŒ¿å, æ¯3è½®) æå–åå¥½å¹¶ä¿å­˜
6. update_memory: æ›´æ–° Preview æ€»ç»“
```

---

## Auth è®¤è¯ç³»ç»Ÿè®¾è®¡

### ç”¨æˆ·èº«ä»½ç±»å‹

| ç±»å‹ | is_anonymous | is_registered | è¯´æ˜ |
|------|-------------|--------------|------|
| åŒ¿åç”¨æˆ· | true | false | è‡ªåŠ¨åˆ›å»ºï¼Œåç§°ä¸º"è®¿å®¢_xxxxxx" |
| æ³¨å†Œç”¨æˆ· | false | true | è®¾ç½®äº†åå­—+å£ä»¤+å°ç§˜å¯† |

### API ç«¯ç‚¹

```
POST /auth/anonymous          # åˆ›å»ºåŒ¿åç”¨æˆ·
POST /auth/register           # å®Œæ•´æ³¨å†Œï¼ˆåå­—+æ€§åˆ«+å£ä»¤+å°ç§˜å¯†ï¼‰
POST /auth/upgrade            # åŒ¿åå‡çº§ä¸ºæ³¨å†Œç”¨æˆ·
POST /auth/verify/passphrase  # å£ä»¤éªŒè¯
GET  /auth/verify/challenge   # è·å–éšæœºå°ç§˜å¯†æŒ‘æˆ˜é¢˜
POST /auth/verify/secret      # éªŒè¯å°ç§˜å¯†ç­”æ¡ˆ
GET  /auth/secrets/catalog    # è·å–å°ç§˜å¯†é¢˜ç›®ç›®å½•
GET  /auth/user/{user_id}     # è·å–ç”¨æˆ·ä¿¡æ¯
```

### å°ç§˜å¯†è®¤è¯

ç”¨æˆ·æ³¨å†Œæ—¶é€‰æ‹©å¹¶å›ç­”å°ç§˜å¯†é¢˜ç›®ï¼ˆ14é“é¢˜ï¼šé€šç”¨6é“+ç”·æ€§4é“+å¥³æ€§4é“ï¼‰ï¼Œç­”æ¡ˆ SHA-256 åŠ å¯†å­˜å‚¨ã€‚ç™»å½•æ—¶å¯ç”¨ã€Œå£ä»¤ã€æˆ–ã€Œå°ç§˜å¯†æŒ‘æˆ˜ã€ä¸¤ç§æ–¹å¼éªŒè¯ã€‚

---

## ä»Šæ—¥å®Œæˆ

- [x] Soul é¡¹ç›®å®Œæ•´è®¾è®¡æ–‡æ¡£
- [x] Persona ç³»ç»Ÿè®¾è®¡ï¼ˆä» maker åŠ è½½ï¼‰
- [x] åŠ¨æ€ç¼“å­˜ç®¡ç†è®¾è®¡
- [x] è¯¦ç»†ä»£ç ç»“æ„è®¾è®¡
- [x] é…ç½®ç³»ç»Ÿè®¾è®¡
- [x] é€šç”¨åŒ–è®¾è®¡ï¼ˆé¢†åŸŸæ— å…³ï¼‰
- [x] ç¡®è®¤æ‰€æœ‰å¾…ç¡®è®¤é—®é¢˜ (Q1-Q8)
- [x] è®°å¿†ä¿ç•™ç­–ç•¥è¯¦ç»†è®¾è®¡ï¼ˆ14å¤©è¯¦ç»†+æ°¸ä¹…Preview+å½’æ¡£ï¼‰
- [x] æ‰“æ‹›å‘¼æœºåˆ¶è¯¦ç»†è®¾è®¡ï¼ˆåŠ¨æ€åé¦ˆ+é£æ ¼æ¨¡æ¿ï¼‰
- [x] é”™è¯¯æ¢å¤ä¸æ—¥å¿—ç³»ç»Ÿè®¾è®¡
- [x] æµ‹è¯•ç­–ç•¥è¯¦ç»†è®¾è®¡
- [x] éƒ¨ç½²é…ç½®è®¾è®¡ï¼ˆDocker+å¤šå®ä¾‹ï¼‰
- [x] Connection Agent è¿æ¥åŠ©æ‰‹é›†æˆï¼ˆå·¥ä½œæµ+èŠ‚ç‚¹+é…ç½®+åå¥½ç³»ç»Ÿï¼‰
- [x] Auth è®¤è¯ç³»ç»Ÿï¼ˆåŒ¿åç”¨æˆ·+æ³¨å†Œ+å£ä»¤+å°ç§˜å¯†éªŒè¯ï¼‰

