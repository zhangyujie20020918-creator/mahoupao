<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI训练 - Video Analysis</title>
    <style>
      :root {
        --primary-color: #8b5cf6;
        --primary-hover: #7c3aed;
        --secondary-color: #06b6d4;
        --bg-color: #1a1a1a;
        --card-bg: #242424;
        --text-color: rgba(255, 255, 255, 0.87);
        --text-muted: rgba(255, 255, 255, 0.6);
        --border-color: rgba(255, 255, 255, 0.1);
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --error-color: #ef4444;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        min-height: 100vh;
      }

      #app { max-width: 1000px; margin: 0 auto; padding: 2rem; }

      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
      }

      .title {
        font-size: 1.75rem;
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary-color), #ec4899);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }

      .nav-links {
        display: flex;
        gap: 0.5rem;
      }

      .nav-link {
        color: var(--text-muted);
        text-decoration: none;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        transition: all 0.2s;
      }

      .nav-link:hover { background: var(--card-bg); color: var(--text-color); }

      .card {
        background: var(--card-bg);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border: 1px solid var(--border-color);
      }

      .card-title {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-muted);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .blogger-list { display: grid; gap: 0.75rem; }

      .blogger-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 1rem;
        background: var(--bg-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
      }

      .blogger-item:hover { border-color: var(--primary-color); }
      .blogger-item.selected { border-color: var(--primary-color); background: rgba(139, 92, 246, 0.1); }

      .blogger-name { font-weight: 600; font-size: 1.05rem; }

      .blogger-stats {
        display: flex;
        gap: 1rem;
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 0.25rem;
      }

      .badge {
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
      }

      .badge-video { background: #3b82f6; color: white; }
      .badge-asr { background: #10b981; color: white; }
      .badge-trained { background: var(--primary-color); color: white; }
      .badge-pending { background: var(--warning-color); color: white; }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        gap: 0.5rem;
      }

      .btn-primary { background: var(--primary-color); color: white; }
      .btn-secondary { background: var(--secondary-color); color: white; }
      .btn:hover:not(:disabled) { filter: brightness(1.1); }
      .btn:disabled { opacity: 0.5; cursor: not-allowed; }

      .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        margin-right: 0.5rem;
      }

      .status-dot.online { background: var(--success-color); }
      .status-dot.offline { background: var(--error-color); }

      .progress-section { margin-top: 1.5rem; }

      .step-list { display: grid; gap: 0.75rem; }

      .step-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1rem;
        background: var(--bg-color);
        border-radius: 8px;
      }

      .step-number {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: var(--border-color);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
      }

      .step-item.active .step-number { background: var(--primary-color); }
      .step-item.done .step-number { background: var(--success-color); }
      .step-item.warning .step-number { background: var(--warning-color); }
      .step-item.error .step-number { background: var(--error-color); }

      .step-content { flex: 1; }
      .step-title { font-weight: 600; }
      .step-message { font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem; }

      .progress-bar-container {
        height: 6px;
        background: var(--border-color);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 0.5rem;
      }

      .progress-bar {
        height: 100%;
        background: var(--primary-color);
        transition: width 0.3s;
      }

      .spinner {
        width: 16px;
        height: 16px;
        border: 2px solid var(--border-color);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin { to { transform: rotate(360deg); } }

      .empty-state {
        text-align: center;
        padding: 3rem;
        color: var(--text-muted);
      }

      .persona-preview {
        background: var(--bg-color);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
      }

      .persona-section {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-color);
      }

      .persona-section:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
      }

      .persona-label {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      .persona-value {
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .tag-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
      }

      .tag {
        padding: 0.25rem 0.75rem;
        background: var(--card-bg);
        border-radius: 20px;
        font-size: 0.85rem;
      }

      .system-prompt {
        font-family: monospace;
        font-size: 0.85rem;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
        background: var(--card-bg);
        padding: 1rem;
        border-radius: 8px;
        line-height: 1.6;
      }

      .checkbox-group {
        display: flex;
        gap: 1.5rem;
        margin-bottom: 1rem;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        cursor: pointer;
      }

      .checkbox-item input {
        width: 18px;
        height: 18px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="header">
        <h1 class="title">AI 训练</h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
          <span>
            <span class="status-dot" :class="serviceOnline ? 'online' : 'offline'"></span>
            {{ serviceOnline ? '服务在线' : '服务离线' }}
          </span>
          <div class="nav-links">
            <a href="voice.html" class="nav-link">声音克隆</a>
            <a href="cleaner.html" class="nav-link">数据清洗</a>
            <a href="index.html" class="nav-link">返回下载</a>
          </div>
        </div>
      </div>

      <!-- 服务离线 -->
      <div v-if="!serviceOnline" class="card">
        <div class="empty-state">
          <p style="font-size: 1.25rem; margin-bottom: 1rem;">训练服务未启动</p>
          <code style="display: block; padding: 1rem; background: var(--bg-color); border-radius: 8px; text-align: left;">
            cd video-analysis-maker<br>
            pip install -r requirements.txt<br>
            python run_server.py
          </code>
        </div>
      </div>

      <template v-if="serviceOnline">
        <!-- 状态信息 -->
        <div class="card">
          <div class="card-title">
            <span class="status-dot" :class="statusInfo.gpu?.available ? 'online' : 'offline'"></span>
            系统状态
          </div>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
            <div>
              <div style="color: var(--text-muted); font-size: 0.85rem;">GPU</div>
              <div>{{ statusInfo.gpu?.available ? statusInfo.gpu.name : 'CPU 模式' }}</div>
            </div>
            <div>
              <div style="color: var(--text-muted); font-size: 0.85rem;">LLM 模型</div>
              <div>{{ statusInfo.gemini_model || '-' }}</div>
            </div>
            <div>
              <div style="color: var(--text-muted); font-size: 0.85rem;">Embedding 模型</div>
              <div>{{ statusInfo.embedding_model || '-' }}</div>
            </div>
            <div>
              <div style="color: var(--text-muted); font-size: 0.85rem;">Gemini API</div>
              <div :style="{ color: statusInfo.gemini_configured ? 'var(--success-color)' : 'var(--error-color)' }">
                {{ statusInfo.gemini_configured ? '已配置' : '未配置' }}
              </div>
            </div>
          </div>
        </div>

        <!-- 博主列表 -->
        <div class="card">
          <div class="card-title">选择博主</div>
          <div v-if="bloggers.length === 0" class="empty-state">
            <p>没有找到博主，请先下载视频并进行数据清洗</p>
          </div>
          <div v-else class="blogger-list">
            <div
              v-for="blogger in bloggers"
              :key="blogger.name"
              class="blogger-item"
              :class="{ selected: selectedBlogger === blogger.name }"
              @click="selectBlogger(blogger.name)"
            >
              <div>
                <div class="blogger-name">{{ blogger.name }}</div>
                <div class="blogger-stats">
                  <span><span class="badge badge-video">{{ blogger.video_count }}</span> 视频</span>
                  <span><span class="badge badge-asr">{{ blogger.asr_count }}</span> ASR</span>
                  <span v-if="blogger.trained">
                    <span class="badge badge-trained">已训练</span>
                  </span>
                  <span v-else>
                    <span class="badge badge-pending">待训练</span>
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- 训练选项 -->
        <div v-if="selectedBlogger" class="card">
          <div class="card-title">训练选项</div>

          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="checkbox" v-model="skipOptimization">
              <span>跳过文本优化（使用已有结果）</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" v-model="skipVectordb">
              <span>跳过向量数据库</span>
            </label>
            <label class="checkbox-item">
              <input type="checkbox" v-model="skipPersona">
              <span>跳过人格画像</span>
            </label>
          </div>

          <button
            class="btn btn-primary"
            :disabled="training"
            @click="startTraining"
          >
            <span v-if="training" class="spinner"></span>
            {{ training ? '训练中...' : '开始训练' }}
          </button>

          <!-- 训练进度 -->
          <div v-if="steps.length > 0" class="progress-section">
            <div class="step-list">
              <div
                v-for="step in steps"
                :key="step.step"
                class="step-item"
                :class="step.status"
              >
                <div class="step-number">{{ step.step }}</div>
                <div class="step-content">
                  <div class="step-title">{{ step.title }}</div>
                  <div class="step-message">{{ step.message }}</div>
                  <div v-if="step.progress" class="progress-bar-container">
                    <div class="progress-bar" :style="{ width: step.progress + '%' }"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- 训练结果 -->
          <div v-if="trainingDone && bloggerDetail" class="progress-section">
            <div class="card-title" style="color: var(--success-color);">训练完成</div>

            <!-- 人格画像预览 -->
            <div v-if="bloggerDetail.persona" class="persona-preview">
              <div class="persona-section">
                <div class="persona-label">说话风格</div>
                <div class="persona-value">{{ bloggerDetail.persona.speaking_style }}</div>
              </div>
              <div class="persona-section">
                <div class="persona-label">常用语</div>
                <div class="tag-list">
                  <span v-for="phrase in bloggerDetail.persona.common_phrases" :key="phrase" class="tag">
                    {{ phrase }}
                  </span>
                </div>
              </div>
              <div class="persona-section">
                <div class="persona-label">专业领域</div>
                <div class="tag-list">
                  <span v-for="topic in bloggerDetail.persona.topic_expertise" :key="topic" class="tag">
                    {{ topic }}
                  </span>
                </div>
              </div>
            </div>

            <!-- System Prompt -->
            <div v-if="bloggerDetail.system_prompt" style="margin-top: 1rem;">
              <div class="persona-label">System Prompt</div>
              <div class="system-prompt">{{ bloggerDetail.system_prompt }}</div>
            </div>

            <!-- 向量数据库统计 -->
            <div v-if="bloggerDetail.vectordb_stats" style="margin-top: 1rem;">
              <div class="persona-label">向量数据库</div>
              <div style="color: var(--text-muted);">
                共 {{ bloggerDetail.vectordb_stats.document_count }} 条记录
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script>
      var API = 'http://localhost:8002/api/maker';

      var app = Vue.createApp({
        data: function() {
          return {
            serviceOnline: false,
            statusInfo: {},
            bloggers: [],
            selectedBlogger: null,

            skipOptimization: false,
            skipVectordb: false,
            skipPersona: false,

            training: false,
            trainingDone: false,
            steps: [],
            bloggerDetail: null,
          };
        },
        mounted: function() {
          this.checkService();
        },
        methods: {
          checkService: function() {
            var vm = this;
            fetch(API + '/status')
              .then(function(r) { return r.json(); })
              .then(function(data) {
                vm.serviceOnline = true;
                vm.statusInfo = data;
                vm.loadBloggers();
              })
              .catch(function() {
                vm.serviceOnline = false;
              });
          },

          loadBloggers: function() {
            var vm = this;
            fetch(API + '/bloggers')
              .then(function(r) { return r.json(); })
              .then(function(data) { vm.bloggers = data.bloggers; });
          },

          selectBlogger: function(name) {
            this.selectedBlogger = name;
            this.steps = [];
            this.trainingDone = false;
            this.bloggerDetail = null;

            // 如果已训练，加载详情
            var blogger = this.bloggers.find(function(b) { return b.name === name; });
            if (blogger && blogger.trained) {
              this.loadBloggerDetail(name);
            }
          },

          loadBloggerDetail: function(name) {
            var vm = this;
            fetch(API + '/blogger/' + encodeURIComponent(name))
              .then(function(r) { return r.json(); })
              .then(function(data) {
                vm.bloggerDetail = data;
                vm.trainingDone = true;
              });
          },

          startTraining: function() {
            var vm = this;
            vm.training = true;
            vm.trainingDone = false;
            vm.bloggerDetail = null;
            vm.steps = [
              { step: 1, title: '文本优化', message: '等待中...', status: '', progress: 0 },
              { step: 2, title: '向量数据库', message: '等待中...', status: '', progress: 0 },
              { step: 3, title: '人格画像', message: '等待中...', status: '', progress: 0 },
            ];

            fetch(API + '/train', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                blogger_name: vm.selectedBlogger,
                skip_optimization: vm.skipOptimization,
                skip_vectordb: vm.skipVectordb,
                skip_persona: vm.skipPersona,
              }),
            }).then(function(response) {
              var reader = response.body.getReader();
              var decoder = new TextDecoder();

              function read() {
                reader.read().then(function(result) {
                  if (result.done) {
                    vm.training = false;
                    return;
                  }

                  var lines = decoder.decode(result.value).split('\n');
                  lines.forEach(function(line) {
                    if (line.startsWith('data: ')) {
                      try {
                        var data = JSON.parse(line.substring(6));
                        vm.handleTrainingEvent(data);
                      } catch (e) {}
                    }
                  });
                  read();
                });
              }
              read();
            });
          },

          handleTrainingEvent: function(data) {
            var vm = this;

            if (data.type === 'step') {
              var step = vm.steps.find(function(s) { return s.step === data.step; });
              if (step) {
                step.status = 'active';
                step.message = data.message;
              }
            } else if (data.type === 'progress') {
              var step = vm.steps.find(function(s) { return s.step === data.step; });
              if (step) {
                step.progress = Math.round((data.current / data.total) * 100);
                step.message = data.file + ' (' + data.current + '/' + data.total + ')';
              }
            } else if (data.type === 'step_done') {
              var step = vm.steps.find(function(s) { return s.step === data.step; });
              if (step) {
                step.status = 'done';
                step.message = data.message;
                step.progress = 100;
              }
            } else if (data.type === 'warning') {
              var step = vm.steps.find(function(s) { return s.step === data.step; });
              if (step) {
                step.status = 'warning';
                step.message = data.message;
              }
            } else if (data.type === 'error') {
              vm.training = false;
              alert('训练失败: ' + data.message);
            } else if (data.type === 'done') {
              vm.training = false;
              vm.trainingDone = true;
              vm.loadBloggers();
              vm.loadBloggerDetail(vm.selectedBlogger);
            }
          },
        },
      });

      app.mount('#app');
    </script>
  </body>
</html>
